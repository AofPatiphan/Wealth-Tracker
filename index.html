<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Wealth Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-indigo-600"><i class="fas fa-chart-line mr-2"></i>Wealth Tracker</h1>
            <div class="flex items-center space-x-3">
                <!-- Auth UI -->
                <div id="authSection" class="flex items-center space-x-2">
                    <div id="userInfo" class="hidden flex items-center space-x-2">
                        <img id="userAvatar" src="" alt="" class="w-8 h-8 rounded-full border-2 border-indigo-300">
                        <span id="userName" class="text-sm text-gray-600 hidden sm:inline"></span>
                        <button onclick="signOutUser()" class="text-sm text-red-500 hover:text-red-700" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                    <button id="signInBtn" onclick="signInWithGoogle()" class="bg-white border border-gray-300 text-gray-700 px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50 flex items-center space-x-2 shadow-sm">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="w-4 h-4">
                        <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
                    </button>
                </div>
                <div class="border-l pl-3 space-x-2">
                    <button onclick="exportData()" class="text-sm text-gray-500 hover:text-indigo-600"><i class="fas fa-download"></i> <span class="hidden sm:inline">Backup</span></button>
                    <label for="importFile" class="text-sm text-gray-500 hover:text-indigo-600 cursor-pointer"><i class="fas fa-upload"></i> <span class="hidden sm:inline">Restore</span></label>
                    <input type="file" id="importFile" class="hidden" onchange="importData(this)">
                </div>
            </div>
        </div>
        <!-- Sync Status Bar -->
        <div id="syncStatus" class="hidden bg-indigo-50 border-t border-indigo-100 px-4 py-1 text-center text-xs text-indigo-600">
            <i class="fas fa-cloud"></i> <span id="syncText">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• sync ‡∏Å‡∏±‡∏ö Cloud</span>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto px-4 py-6 w-full gap-6 flex flex-col lg:flex-row">
        
        <aside class="w-full lg:w-1/3 space-y-6">
            
            <div class="bg-indigo-600 rounded-xl p-6 text-white shadow-lg">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-indigo-200 text-sm">‡∏£‡∏≤‡∏Ñ‡∏≤ S&P 500 ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (NAV)</p>
                        <div class="flex items-baseline mt-1">
                            <input type="number" id="currentSp500" value="5800" step="0.01" class="bg-transparent text-3xl font-bold w-32 focus:outline-none border-b border-indigo-400" onchange="renderDashboard()">
                            <span class="ml-1 text-sm">USD</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-indigo-200 text-sm">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏û‡∏≠‡∏£‡πå‡∏ï DCA</p>
                        <p class="text-2xl font-bold mt-1" id="portValue">Loading...</p>
                        <p class="text-xs text-indigo-300" id="portReturn">---</p>
                    </div>
                </div>
                <!-- Units and NAV Info -->
                <div class="mt-4 pt-4 border-t border-indigo-500 grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-indigo-200 text-xs">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</p>
                        <p class="text-xl font-bold mt-1" id="totalUnits">0.00</p>
                        <p class="text-xs text-indigo-300">Units</p>
                    </div>
                    <div class="text-right">
                        <p class="text-indigo-200 text-xs">NAV ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                        <p class="text-xl font-bold mt-1" id="currentNAV">0.00</p>
                        <p class="text-xs text-indigo-300">USD/Unit</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                <h2 class="text-lg font-semibold mb-4 border-b pb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
                <form id="dataForm" class="space-y-4">
                    <input type="hidden" id="editIndex">
                    
                    <!-- ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ (YYYY-MM)</label>
                            <input type="month" id="inputMonth" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" id="inputSalary" placeholder="40,000" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 border p-2" oninput="calculateRemaining()">
                        </div>
                    </div>

                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ Dynamic -->
                    <div class="p-3 bg-orange-50 rounded-lg border border-orange-200">
                        <div class="flex justify-between items-center mb-3">
                            <p class="text-xs font-bold text-orange-600 uppercase">üí∏ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</p>
                            <button type="button" onclick="addExpenseRow()" class="text-xs bg-orange-500 text-white px-2 py-1 rounded hover:bg-orange-600 transition">
                                <i class="fas fa-plus mr-1"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                            </button>
                        </div>
                        <div id="expenseContainer" class="space-y-2">
                            <!-- Dynamic expense rows will be added here -->
                        </div>
                        <button type="button" onclick="addExpenseRow()" class="mt-2 w-full py-2 border-2 border-dashed border-orange-300 rounded-md text-orange-500 text-sm hover:bg-orange-100 transition">
                            <i class="fas fa-plus mr-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
                        </button>
                        
                        <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° -->
                        <div class="mt-3 pt-3 border-t border-orange-200 flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢:</span>
                            <span id="totalExpenseDisplay" class="text-lg font-bold text-red-500">‡∏ø0</span>
                        </div>
                    </div>

                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô DCA -->
                    <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                        <p class="text-xs font-bold text-indigo-600 mb-2 uppercase">üìà ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô DCA</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô DCA (‡∏ö‡∏≤‡∏ó)</label>
                                <input type="number" id="inputDCA" placeholder="0" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md border p-2" oninput="calculateRemaining()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">NAV ‡∏ï‡∏≠‡∏ô‡∏ã‡∏∑‡πâ‡∏≠ (S&P)</label>
                                <input type="number" id="inputIndexPrice" placeholder="‡πÄ‡∏ä‡πà‡∏ô 4500.50" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md border p-2">
                                <p class="text-xs text-gray-400 mt-1">*‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Unit ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á</p>
                            </div>
                        </div>
                    </div>

                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (Radio) -->
                    <div class="p-3 bg-green-50 rounded-lg border border-green-200">
                        <p class="text-xs font-bold text-green-600 mb-3 uppercase">üè¶ ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</p>
                        
                        <!-- Radio Options -->
                        <div class="space-y-2">
                            <label class="flex items-center p-3 bg-white rounded-lg border-2 cursor-pointer transition hover:border-green-400" id="radioAutoLabel">
                                <input type="radio" name="emergencyType" value="auto" checked class="w-4 h-4 text-green-600 border-gray-300 focus:ring-green-500" onchange="toggleEmergencyMode()">
                                <div class="ml-3 flex-1">
                                    <span class="text-sm font-medium text-gray-800">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
                                    <p class="text-xs text-gray-500">= ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô - ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î - DCA</p>
                                </div>
                                <span id="autoEmergencyValue" class="text-lg font-bold text-green-600">‡∏ø0</span>
                            </label>
                            
                            <label class="flex items-center p-3 bg-white rounded-lg border-2 cursor-pointer transition hover:border-green-400" id="radioCustomLabel">
                                <input type="radio" name="emergencyType" value="custom" class="w-4 h-4 text-green-600 border-gray-300 focus:ring-green-500" onchange="toggleEmergencyMode()">
                                <div class="ml-3 flex-1">
                                    <span class="text-sm font-medium text-gray-800">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</span>
                                    <p class="text-xs text-gray-500">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°</p>
                                </div>
                            </label>
                        </div>
                        
                        <!-- Custom Input (hidden by default) -->
                        <div id="customEmergencySection" class="mt-3 hidden">
                            <label class="block text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" id="inputEmergency" placeholder="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 border p-2">
                            <p id="emergencyWarning" class="text-xs text-orange-500 mt-1 hidden"></p>
                        </div>
                        
                        <!-- Summary Box -->
                        <div class="mt-3 p-3 bg-green-100 rounded-lg">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢+DCA:</span>
                                <span id="remainingDisplay" class="font-bold text-gray-800">‡∏ø0</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2 pt-2">
                        <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button type="button" onclick="resetForm()" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 text-gray-600">‡∏•‡πâ‡∏≤‡∏á</button>
                    </div>
                </form>
            </div>
        </aside>

        <section class="w-full lg:w-2/3 space-y-6">
            
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                <h2 class="text-lg font-semibold mb-4">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</h2>
                <div class="h-80 w-full">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                    <h2 class="text-lg font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>
                    <span class="text-xs text-gray-400">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-purple-600 uppercase tracking-wider">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-green-600 uppercase tracking-wider">‡∏≠‡∏≠‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-red-500 uppercase tracking-wider">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-blue-600 uppercase tracking-wider">DCA</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">NAV</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-cyan-600 uppercase tracking-wider">Units</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200 text-sm">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA87Jp9YJWZtz-SXFzInXPhMa6ptlZ6EwQ",
            authDomain: "wealth-tracker-7ff8c.firebaseapp.com",
            projectId: "wealth-tracker-7ff8c",
            storageBucket: "wealth-tracker-7ff8c.firebasestorage.app",
            messagingSenderId: "223313325112",
            appId: "1:223313325112:web:c5366d94d3a24d1c2acacd",
            measurementId: "G-YPC6L2QLWW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let unsubscribeSnapshot = null;

        // Make functions globally available
        window.signInWithGoogle = async function() {
            try {
                const result = await signInWithPopup(auth, provider);
                showNotification('‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            } catch (error) {
                console.error('Sign in error:', error);
                showNotification('‚ùå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message);
            }
        };

        window.signOutUser = async function() {
            try {
                await signOut(auth);
                showNotification('üëã ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
            } catch (error) {
                console.error('Sign out error:', error);
            }
        };

        // Save data to Firestore
        async function saveToCloud(data) {
            if (!currentUser) return;
            try {
                await setDoc(doc(db, "users", currentUser.uid), {
                    records: data,
                    updatedAt: new Date().toISOString()
                });
                updateSyncStatus('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (error) {
                console.error('Save error:', error);
                updateSyncStatus('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        }

        // Load data from Firestore
        async function loadFromCloud() {
            if (!currentUser) return null;
            try {
                const docRef = doc(db, "users", currentUser.uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data().records || [];
                }
                return null;
            } catch (error) {
                console.error('Load error:', error);
                return null;
            }
        }

        // Real-time listener for data sync
        function setupRealtimeSync() {
            if (!currentUser || unsubscribeSnapshot) return;
            
            const docRef = doc(db, "users", currentUser.uid);
            unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const cloudData = docSnap.data().records || [];
                    // Only update if different from current records
                    if (JSON.stringify(cloudData) !== JSON.stringify(window.records)) {
                        window.records = cloudData;
                        localStorage.setItem('wealthData', JSON.stringify(cloudData));
                        window.renderDashboard();
                        updateSyncStatus('üîÑ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• sync ‡πÅ‡∏•‡πâ‡∏ß');
                    }
                }
            }, (error) => {
                console.error('Snapshot error:', error);
            });
        }

        function updateSyncStatus(text) {
            const syncText = document.getElementById('syncText');
            if (syncText) {
                syncText.textContent = text;
                setTimeout(() => {
                    if (currentUser) {
                        syncText.textContent = '‚òÅÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• sync ‡∏Å‡∏±‡∏ö Cloud';
                    }
                }, 2000);
            }
        }

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            const signInBtn = document.getElementById('signInBtn');
            const userInfo = document.getElementById('userInfo');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const syncStatus = document.getElementById('syncStatus');

            if (user) {
                currentUser = user;
                
                // Update UI
                signInBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userInfo.classList.add('flex');
                userAvatar.src = user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || 'U');
                userName.textContent = user.displayName || user.email;
                syncStatus.classList.remove('hidden');

                // Load data from cloud
                const cloudData = await loadFromCloud();
                if (cloudData && cloudData.length > 0) {
                    window.records = cloudData;
                    localStorage.setItem('wealthData', JSON.stringify(cloudData));
                    window.renderDashboard();
                    updateSyncStatus('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cloud ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } else if (window.records.length > 0) {
                    // First time login with existing local data - upload to cloud
                    await saveToCloud(window.records);
                    updateSyncStatus('‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Cloud ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }

                // Setup real-time sync
                setupRealtimeSync();

                // Override saveData to also save to cloud
                window.saveDataOriginal = window.saveData;
                window.saveData = function() {
                    window.records.sort((a, b) => new Date(a.month) - new Date(b.month));
                    localStorage.setItem('wealthData', JSON.stringify(window.records));
                    window.renderDashboard();
                    window.resetForm();
                    // Save to cloud
                    saveToCloud(window.records);
                };

            } else {
                currentUser = null;
                
                // Update UI
                signInBtn.classList.remove('hidden');
                userInfo.classList.add('hidden');
                userInfo.classList.remove('flex');
                syncStatus.classList.add('hidden');

                // Unsubscribe from real-time updates
                if (unsubscribeSnapshot) {
                    unsubscribeSnapshot();
                    unsubscribeSnapshot = null;
                }

                // Restore original saveData
                if (window.saveDataOriginal) {
                    window.saveData = window.saveDataOriginal;
                }
            }
        });
    </script>

    <script>
        // --- DATA STRUCTURE & STATE ---
        window.records = [];
        const THB_USD_RATE = 34.5;
        let expenseRowCounter = 0;
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderDashboard();
            addExpenseRow();
            calculateRemaining();
        });

        // --- CORE FUNCTIONS ---

        window.saveData = function() {
            records.sort((a, b) => new Date(a.month) - new Date(b.month));
            localStorage.setItem('wealthData', JSON.stringify(records));
            renderDashboard();
            resetForm();
        }

        function loadData() {
            const stored = localStorage.getItem('wealthData');
            if (stored) {
                window.records = JSON.parse(stored);
            } else {
                window.records = [];
            }
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(records));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "wealth_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    window.records = JSON.parse(e.target.result);
                    saveData();
                    showNotification("‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                } catch (err) {
                    showNotification("‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }
            };
            reader.readAsText(file);
        }

        // --- EXPENSE MANAGEMENT ---

        function addExpenseRow(name = '', amount = '') {
            const container = document.getElementById('expenseContainer');
            const rowId = `expense_${expenseRowCounter++}`;
            
            const row = document.createElement('div');
            row.className = 'flex gap-2 items-center';
            row.id = rowId;
            row.innerHTML = `
                <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏Å‡∏¥‡∏ô)" value="${name}" 
                    class="flex-1 rounded-md border-gray-300 border p-2 text-sm focus:border-orange-500" 
                    oninput="calculateRemaining()">
                <input type="number" placeholder="0" value="${amount}" step="0.01"
                    class="w-28 rounded-md border-gray-300 border p-2 text-sm text-right focus:border-orange-500" 
                    oninput="calculateRemaining()">
                <button type="button" onclick="removeExpenseRow('${rowId}')" 
                    class="w-8 h-8 flex items-center justify-center bg-red-100 text-red-500 rounded hover:bg-red-500 hover:text-white transition">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(row);
            calculateRemaining();
        }

        function removeExpenseRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                calculateRemaining();
            }
        }

        function getExpenseItems() {
            const items = [];
            document.querySelectorAll('#expenseContainer > div').forEach(row => {
                const inputs = row.querySelectorAll('input');
                const name = inputs[0].value.trim();
                const amount = parseFloat(inputs[1].value) || 0;
                if (name && amount > 0) {
                    items.push({ name, amount });
                }
            });
            return items;
        }

        function getTotalExpenses() {
            let total = 0;
            document.querySelectorAll('#expenseContainer > div').forEach(row => {
                const amountInput = row.querySelectorAll('input')[1];
                total += parseFloat(amountInput.value) || 0;
            });
            return total;
        }

        // --- CALCULATION ---

        function calculateRemaining() {
            const salary = parseFloat(document.getElementById('inputSalary').value) || 0;
            const totalExpenses = getTotalExpenses();
            const dca = parseFloat(document.getElementById('inputDCA').value) || 0;
            
            const remaining = salary - totalExpenses - dca;
            
            document.getElementById('totalExpenseDisplay').textContent = `‡∏ø${totalExpenses.toLocaleString()}`;
            document.getElementById('remainingDisplay').textContent = `‡∏ø${remaining.toLocaleString()}`;
            document.getElementById('autoEmergencyValue').textContent = `‡∏ø${Math.max(0, remaining).toLocaleString()}`;
            
            const remainingEl = document.getElementById('remainingDisplay');
            if (remaining < 0) {
                remainingEl.classList.remove('text-gray-800', 'text-green-600');
                remainingEl.classList.add('text-red-500');
            } else {
                remainingEl.classList.remove('text-red-500');
                remainingEl.classList.add('text-green-600');
            }
            
            const emergencyType = document.querySelector('input[name="emergencyType"]:checked').value;
            if (emergencyType === 'custom') {
                const customAmount = parseFloat(document.getElementById('inputEmergency').value) || 0;
                const warningEl = document.getElementById('emergencyWarning');
                if (customAmount > remaining) {
                    warningEl.textContent = `‚ö†Ô∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (${remaining.toLocaleString()} ‡∏ö‡∏≤‡∏ó)`;
                    warningEl.classList.remove('hidden');
                } else {
                    warningEl.classList.add('hidden');
                }
            }
        }

        function toggleEmergencyMode() {
            const emergencyType = document.querySelector('input[name="emergencyType"]:checked').value;
            const customSection = document.getElementById('customEmergencySection');
            const autoLabel = document.getElementById('radioAutoLabel');
            const customLabel = document.getElementById('radioCustomLabel');
            
            if (emergencyType === 'custom') {
                customSection.classList.remove('hidden');
                autoLabel.classList.remove('border-green-500');
                autoLabel.classList.add('border-gray-200');
                customLabel.classList.remove('border-gray-200');
                customLabel.classList.add('border-green-500');
            } else {
                customSection.classList.add('hidden');
                autoLabel.classList.remove('border-gray-200');
                autoLabel.classList.add('border-green-500');
                customLabel.classList.remove('border-green-500');
                customLabel.classList.add('border-gray-200');
            }
            calculateRemaining();
        }

        // --- FORM HANDLING ---

        const form = document.getElementById('dataForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const editIndex = document.getElementById('editIndex').value;
            
            const salary = parseFloat(document.getElementById('inputSalary').value) || 0;
            const expenses = getExpenseItems();
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
            const dca = parseFloat(document.getElementById('inputDCA').value) || 0;
            const remaining = salary - totalExpenses - dca;
            
            const emergencyType = document.querySelector('input[name="emergencyType"]:checked').value;
            let emergency;
            if (emergencyType === 'auto') {
                emergency = Math.max(0, remaining);
            } else {
                emergency = parseFloat(document.getElementById('inputEmergency').value) || 0;
            }
            
            const newRecord = {
                month: document.getElementById('inputMonth').value,
                salary: salary,
                emergency: emergency,
                expenses: expenses,
                dca: dca,
                indexPrice: parseFloat(document.getElementById('inputIndexPrice').value) || 0
            };

            if (editIndex !== "") {
                window.records[editIndex] = newRecord;
            } else {
                const existing = window.records.findIndex(r => r.month === newRecord.month);
                if (existing >= 0) {
                    if(!confirm("‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
                    window.records[existing] = newRecord;
                } else {
                    window.records.push(newRecord);
                }
            }
            saveData();
        });

        function editRecord(index) {
            const r = window.records[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('inputMonth').value = r.month;
            document.getElementById('inputSalary').value = r.salary || 0;
            document.getElementById('inputDCA').value = r.dca;
            document.getElementById('inputIndexPrice').value = r.indexPrice;
            
            document.getElementById('expenseContainer').innerHTML = '';
            expenseRowCounter = 0;
            
            if (r.expenses && Array.isArray(r.expenses)) {
                r.expenses.forEach(exp => addExpenseRow(exp.name, exp.amount));
            } else if (r.expense) {
                addExpenseRow('‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', r.expense);
            }
            
            if (document.querySelectorAll('#expenseContainer > div').length === 0) {
                addExpenseRow();
            }
            
            const salary = r.salary || 0;
            const totalExpenses = r.expenses ? r.expenses.reduce((sum, e) => sum + e.amount, 0) : (r.expense || 0);
            const remaining = salary - totalExpenses - r.dca;
            
            if (Math.abs(r.emergency - Math.max(0, remaining)) < 1) {
                document.querySelector('input[name="emergencyType"][value="auto"]').checked = true;
            } else {
                document.querySelector('input[name="emergencyType"][value="custom"]').checked = true;
                document.getElementById('inputEmergency').value = r.emergency;
            }
            toggleEmergencyMode();
            calculateRemaining();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteRecord(index) {
            if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ?')) {
                window.records.splice(index, 1);
                saveData();
            }
        }

        function duplicateRecord(index) {
            const r = window.records[index];
            
            document.getElementById('editIndex').value = "";
            
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('inputMonth').value = currentMonth;
            
            document.getElementById('inputSalary').value = r.salary || 0;
            document.getElementById('inputDCA').value = r.dca;
            document.getElementById('inputIndexPrice').value = r.indexPrice;
            
            document.getElementById('expenseContainer').innerHTML = '';
            expenseRowCounter = 0;
            
            if (r.expenses && Array.isArray(r.expenses)) {
                r.expenses.forEach(exp => addExpenseRow(exp.name, exp.amount));
            } else if (r.expense) {
                addExpenseRow('‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', r.expense);
            }
            
            if (document.querySelectorAll('#expenseContainer > div').length === 0) {
                addExpenseRow();
            }
            
            const salary = r.salary || 0;
            const totalExpenses = r.expenses ? r.expenses.reduce((sum, e) => sum + e.amount, 0) : (r.expense || 0);
            const remaining = salary - totalExpenses - r.dca;
            
            if (Math.abs(r.emergency - Math.max(0, remaining)) < 1) {
                document.querySelector('input[name="emergencyType"][value="auto"]').checked = true;
            } else {
                document.querySelector('input[name="emergencyType"][value="custom"]').checked = true;
                document.getElementById('inputEmergency').value = r.emergency;
            }
            toggleEmergencyMode();
            calculateRemaining();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showNotification('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà');
        }

        window.showNotification = function(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-indigo-600 text-white px-4 py-3 rounded-lg shadow-lg z-50 animate-pulse';
            notification.innerHTML = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transition = 'opacity 0.3s';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        window.resetForm = function() {
            form.reset();
            document.getElementById('editIndex').value = "";
            document.getElementById('expenseContainer').innerHTML = '';
            expenseRowCounter = 0;
            addExpenseRow();
            document.querySelector('input[name="emergencyType"][value="auto"]').checked = true;
            toggleEmergencyMode();
            calculateRemaining();
        }

        // --- RENDERING & CHARTS ---

        let myChart = null;

        function getRecordTotalExpenses(r) {
            if (r.expenses && Array.isArray(r.expenses)) {
                return r.expenses.reduce((sum, e) => sum + e.amount, 0);
            }
            return r.expense || 0;
        }

        function isFutureMonth(monthStr) {
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            return monthStr > currentMonth;
        }

        function getCurrentMonth() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }

        window.renderDashboard = function() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            let totalInvestedTHB = 0;
            let totalUnits = 0;

            window.records.forEach((r, index) => {
                const totalExpense = getRecordTotalExpenses(r);
                const isFuture = isFutureMonth(r.month);
                
                let rowUnits = 0;
                if (r.dca > 0 && r.indexPrice > 0) {
                    const investedUSD = r.dca / THB_USD_RATE;
                    rowUnits = investedUSD / r.indexPrice;
                }
                
                const tr = document.createElement('tr');
                
                if (isFuture) {
                    tr.className = "bg-gray-100 opacity-60 cursor-pointer transition hover:opacity-80";
                } else {
                    tr.className = "hover:bg-gray-50 cursor-pointer transition";
                }
                
                tr.onclick = (e) => { if(e.target.tagName !== 'BUTTON' && e.target.tagName !== 'I') editRecord(index); };
                
                let expenseDisplay = totalExpense.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                if (r.expenses && r.expenses.length > 1) {
                    const expenseList = r.expenses.map(e => `${e.name}: ‡∏ø${e.amount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`).join('\n');
                    expenseDisplay = `<span title="${expenseList}" class="cursor-help border-b border-dashed border-gray-400">${totalExpense.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>`;
                }
                
                let monthDisplay = r.month;
                if (isFuture) {
                    monthDisplay = `${r.month} <span class="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full font-medium">üìÖ ‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</span>`;
                }
                
                let unitsDisplay = rowUnits > 0 ? rowUnits.toFixed(6) : '-';
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap font-medium ${isFuture ? 'text-gray-500' : 'text-gray-900'}">${monthDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right ${isFuture ? 'text-gray-400' : 'text-purple-600'}">${(r.salary || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right ${isFuture ? 'text-gray-400' : 'text-green-600'}">${r.emergency.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right ${isFuture ? 'text-gray-400' : 'text-red-500'}">${expenseDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right ${isFuture ? 'text-gray-400' : 'text-blue-600'} font-medium">${r.dca.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-gray-500">${r.indexPrice > 0 ? r.indexPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right ${isFuture ? 'text-gray-400' : 'text-cyan-600'} font-mono text-xs">${unitsDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium space-x-2">
                        <button onclick="duplicateRecord(${index})" class="text-indigo-600 hover:text-indigo-900" title="Duplicate"><i class="fas fa-copy"></i></button>
                        <button onclick="deleteRecord(${index})" class="text-red-600 hover:text-red-900" title="Delete"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);

                if (!isFuture && r.dca > 0 && r.indexPrice > 0) {
                    totalInvestedTHB += r.dca;
                    totalUnits += rowUnits;
                }
            });

            const currentSp500 = parseFloat(document.getElementById('currentSp500').value) || 0;
            const currentValueUSD = totalUnits * currentSp500;
            const currentValueTHB = currentValueUSD * THB_USD_RATE;
            
            const profit = currentValueTHB - totalInvestedTHB;
            const profitPercent = totalInvestedTHB > 0 ? (profit / totalInvestedTHB) * 100 : 0;

            document.getElementById('portValue').innerText = `‡∏ø${currentValueTHB.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            const returnEl = document.getElementById('portReturn');
            returnEl.innerHTML = `‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: ‡∏ø${totalInvestedTHB.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} <span class="${profit >= 0 ? 'text-green-300' : 'text-red-300'} ml-2">(${profit >= 0 ? '+' : ''}${profitPercent.toFixed(2)}%)</span>`;

            document.getElementById('totalUnits').innerText = totalUnits.toFixed(6);
            document.getElementById('currentNAV').innerText = currentSp500.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            const validRecords = window.records.filter(r => !isFutureMonth(r.month));
            
            const labels = validRecords.map(r => r.month);
            const dataEmergency = validRecords.map(r => r.emergency);
            const dataDCA = validRecords.map(r => r.dca);
            const dataExpense = validRecords.map(r => getRecordTotalExpenses(r));
            
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô',
                            data: dataEmergency,
                            backgroundColor: '#fbbf24',
                            stack: 'Stack 0',
                        },
                        {
                            label: 'DCA Investment',
                            data: dataDCA,
                            backgroundColor: '#4f46e5',
                            stack: 'Stack 0',
                        },
                        {
                            label: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢',
                            data: dataExpense,
                            type: 'line',
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 3,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false } },
                        y: { stacked: true, beginAtZero: true }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        }
    </script>
</body>
</html>
