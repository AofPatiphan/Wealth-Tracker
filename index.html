<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Wealth Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        
        /* Mobile Responsive Styles */
        @media (max-width: 640px) {
            /* Header */
            header .max-w-7xl { padding: 0.75rem 0.75rem; }
            header h1 { font-size: 1rem; }
            
            /* Portfolio Card */
            .portfolio-card { padding: 1rem !important; }
            .portfolio-card .text-3xl { font-size: 1.5rem !important; }
            .portfolio-card .text-2xl { font-size: 1.25rem !important; }
            .portfolio-card .text-xl { font-size: 1rem !important; }
            
            /* Form sections */
            .form-section { padding: 0.75rem !important; }
            .form-section .text-lg { font-size: 1rem !important; }
            .form-section .text-sm { font-size: 0.8rem !important; }
            .form-section .text-xs { font-size: 0.7rem !important; }
            .form-section input { font-size: 0.875rem !important; padding: 0.5rem !important; }
            .form-section label { font-size: 0.75rem !important; }
            
            /* DCA Toggle */
            .dca-toggle { flex-direction: column; align-items: flex-start !important; gap: 0.5rem; }
            .dca-toggle-label { flex-direction: row; }
            
            /* Buttons */
            .btn-mobile { font-size: 0.8rem !important; padding: 0.5rem 0.75rem !important; }
            
            /* Table */
            table { font-size: 0.75rem !important; }
            table th, table td { padding: 0.5rem 0.25rem !important; }
            
            /* Weekly inputs */
            .weekly-input-row { flex-wrap: wrap; }
            .weekly-input-row input { width: 4rem !important; font-size: 0.75rem !important; }
            .weekly-input-row span { font-size: 0.65rem !important; }
            
            /* Main container */
            main { padding: 0.75rem !important; gap: 1rem !important; }
            
            /* Cards */
            .card-mobile { padding: 1rem !important; }
            .card-mobile h2 { font-size: 1rem !important; }
        }
        
        /* Small phones */
        @media (max-width: 380px) {
            .portfolio-card .text-3xl { font-size: 1.25rem !important; }
            .portfolio-card .grid { gap: 0.5rem !important; }
            .form-section input { height: 2.25rem !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-3 sm:px-4 py-2 sm:py-4 flex justify-between items-center">
            <h1 class="text-base sm:text-xl font-bold text-indigo-600"><i class="fas fa-chart-line mr-1 sm:mr-2"></i><span class="hidden xs:inline">Wealth </span>Tracker</h1>
            <div class="flex items-center space-x-3">
                <!-- Auth UI -->
                <div id="authSection" class="flex items-center space-x-2">
                    <div id="userInfo" class="hidden flex items-center space-x-2">
                        <img id="userAvatar" src="" alt="" class="w-8 h-8 rounded-full border-2 border-indigo-300">
                        <span id="userName" class="text-sm text-gray-600 hidden sm:inline"></span>
                        <button onclick="signOutUser()" class="text-sm text-red-500 hover:text-red-700" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                    <button id="signInBtn" onclick="signInWithGoogle()" class="bg-white border border-gray-300 text-gray-700 px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50 flex items-center space-x-2 shadow-sm">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="w-4 h-4">
                        <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
                    </button>
                </div>
                <div class="border-l pl-3 space-x-2">
                    <button onclick="exportData()" class="text-sm text-gray-500 hover:text-indigo-600"><i class="fas fa-download"></i> <span class="hidden sm:inline">Backup</span></button>
                    <label for="importFile" class="text-sm text-gray-500 hover:text-indigo-600 cursor-pointer"><i class="fas fa-upload"></i> <span class="hidden sm:inline">Restore</span></label>
                    <input type="file" id="importFile" class="hidden" onchange="importData(this)">
                </div>
            </div>
        </div>
        <!-- Sync Status Bar -->
        <div id="syncStatus" class="hidden bg-indigo-50 border-t border-indigo-100 px-4 py-1 text-center text-xs text-indigo-600">
            <i class="fas fa-cloud"></i> <span id="syncText">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• sync ‡∏Å‡∏±‡∏ö Cloud</span>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto px-2 sm:px-4 py-3 sm:py-6 w-full gap-4 sm:gap-6 flex flex-col lg:flex-row">
        
        <aside class="w-full lg:w-1/3 space-y-4 sm:space-y-6">
            
            <div class="bg-indigo-600 rounded-xl p-4 sm:p-6 text-white shadow-lg portfolio-card">
                <div class="flex justify-between items-start gap-2">
                    <div class="flex-1 min-w-0">
                        <p class="text-indigo-200 text-[10px] sm:text-sm">NAV ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                        <div class="flex items-baseline mt-1">
                            <input type="number" id="currentNAV" value="28.00" step="0.0001" class="bg-transparent text-xl sm:text-3xl font-bold w-20 sm:w-28 focus:outline-none border-b border-indigo-400" onchange="renderDashboard()">
                            <span class="ml-1 text-[10px] sm:text-sm">‡∏ö‡∏≤‡∏ó</span>
                        </div>
                    </div>
                    <div class="text-right flex-1 min-w-0">
                        <p class="text-indigo-200 text-[10px] sm:text-sm">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏û‡∏≠‡∏£‡πå‡∏ï DCA</p>
                        <p class="text-lg sm:text-2xl font-bold mt-1 truncate" id="portValue">Loading...</p>
                        <p class="text-[10px] sm:text-xs text-indigo-300 truncate" id="portReturn">---</p>
                    </div>
                </div>
                <!-- Units and NAV Info -->
                <div class="mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-indigo-500 grid grid-cols-2 gap-2 sm:gap-4">
                    <div>
                        <p class="text-indigo-200 text-[10px] sm:text-xs">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</p>
                        <p class="text-base sm:text-xl font-bold mt-0.5 sm:mt-1" id="totalUnits">0.00</p>
                        <p class="text-[10px] sm:text-xs text-indigo-300">Units</p>
                    </div>
                    <div class="text-right">
                        <p class="text-indigo-200 text-[10px] sm:text-xs">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</p>
                        <p class="text-base sm:text-xl font-bold mt-0.5 sm:mt-1 truncate" id="totalCost">‡∏ø0</p>
                        <p class="text-[10px] sm:text-xs text-indigo-300">‡∏ö‡∏≤‡∏ó</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl p-4 sm:p-6 shadow-sm border border-gray-100 card-mobile">
                <h2 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 border-b pb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
                <form id="dataForm" class="space-y-4">
                    <input type="hidden" id="editIndex">
                    
                    <!-- ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -->
                    <div class="grid grid-cols-2 gap-2 sm:gap-4">
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ</label>
                            <input type="month" id="inputMonth" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-1.5 sm:p-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" id="inputSalary" placeholder="40,000" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 border p-1.5 sm:p-2 text-sm" oninput="calculateRemaining()">
                        </div>
                    </div>

                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ Dynamic -->
                    <div class="p-3 bg-orange-50 rounded-lg border border-orange-200 form-section">
                        <div class="flex justify-between items-center mb-2 sm:mb-3">
                            <p class="text-[10px] sm:text-xs font-bold text-orange-600 uppercase">üí∏ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</p>
                            <button type="button" onclick="addExpenseRow()" class="text-[10px] sm:text-xs bg-orange-500 text-white px-2 py-1 rounded hover:bg-orange-600 transition">
                                <i class="fas fa-plus mr-1"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°
                            </button>
                        </div>
                        <div id="expenseContainer" class="space-y-2">
                            <!-- Dynamic expense rows will be added here -->
                        </div>
                        <button type="button" onclick="addExpenseRow()" class="mt-2 w-full py-1.5 sm:py-2 border-2 border-dashed border-orange-300 rounded-md text-orange-500 text-[10px] sm:text-sm hover:bg-orange-100 transition">
                            <i class="fas fa-plus mr-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
                        </button>
                        
                        <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° -->
                        <div class="mt-2 sm:mt-3 pt-2 sm:pt-3 border-t border-orange-200 flex justify-between items-center">
                            <span class="text-xs sm:text-sm font-medium text-gray-700">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢:</span>
                            <span id="totalExpenseDisplay" class="text-sm sm:text-lg font-bold text-red-500">‡∏ø0</span>
                        </div>
                    </div>

                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô DCA -->
                    <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-200 form-section">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-3">
                            <p class="text-xs font-bold text-indigo-600 uppercase">üìà DCA (SCBS&P500E)</p>
                            <!-- DCA Mode Toggle -->
                            <div class="flex items-center space-x-1 sm:space-x-2 text-[10px] sm:text-xs">
                                <span class="text-gray-500 whitespace-nowrap">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="weeklyMode" class="sr-only peer" onchange="toggleDCAMode()">
                                    <div class="w-8 h-4 sm:w-9 sm:h-5 bg-gray-300 peer-focus:ring-2 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 sm:after:h-4 sm:after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                                </label>
                                <span class="text-gray-500 whitespace-nowrap">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</span>
                            </div>
                        </div>
                        
                        <!-- Monthly DCA Mode -->
                        <div id="monthlyDCASection">
                            <div class="grid grid-cols-2 gap-2 sm:gap-4">
                                <div>
                                    <label class="block text-[10px] sm:text-sm font-medium text-gray-700">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô DCA (‡∏ö‡∏≤‡∏ó)</label>
                                    <input type="number" id="inputDCA" placeholder="0" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md border p-1.5 sm:p-2 text-sm" oninput="calculateRemaining()">
                                </div>
                                <div>
                                    <label class="block text-[10px] sm:text-sm font-medium text-gray-700">NAV ‡∏ï‡∏≠‡∏ô‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ö‡∏≤‡∏ó)</label>
                                    <input type="number" id="inputIndexPrice" placeholder="‡πÄ‡∏ä‡πà‡∏ô 27.50" step="0.0001" class="mt-1 block w-full border-gray-300 rounded-md border p-1.5 sm:p-2 text-sm">
                                    <p class="text-[9px] sm:text-xs text-gray-400 mt-1">*‡∏î‡∏π NAV ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà SCB Asset</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Weekly DCA Mode -->
                        <div id="weeklyDCASection" class="hidden">
                            <div class="mb-2 sm:mb-3">
                                <label class="block text-[10px] sm:text-sm font-medium text-gray-700">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (‡∏ö‡∏≤‡∏ó)</label>
                                <input type="number" id="weeklyAmount" placeholder="1000" step="0.01" value="1000" class="mt-1 block w-full border-gray-300 rounded-md border p-1.5 sm:p-2 text-sm" oninput="updateWeeklyTotal()">
                            </div>
                            <div class="mb-2 flex justify-between items-center">
                                <span class="text-[10px] sm:text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ:</span>
                                <span id="wednesdayCount" class="text-[10px] sm:text-xs bg-indigo-100 text-indigo-700 px-1.5 sm:px-2 py-0.5 sm:py-1 rounded">0 ‡∏ß‡∏±‡∏ô</span>
                            </div>
                            <div id="weeklyInputs" class="space-y-1.5 sm:space-y-2 max-h-40 sm:max-h-48 overflow-y-auto">
                                <!-- Weekly inputs will be generated here -->
                            </div>
                            <div class="mt-2 sm:mt-3 pt-2 sm:pt-3 border-t border-indigo-200">
                                <div class="flex justify-between text-[10px] sm:text-sm">
                                    <span class="text-gray-600">‡∏£‡∏ß‡∏° DCA ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ:</span>
                                    <span id="weeklyTotalDCA" class="font-bold text-indigo-600">‡∏ø0</span>
                                </div>
                                <div class="flex justify-between text-[10px] sm:text-sm mt-1">
                                    <span class="text-gray-600">‡∏£‡∏ß‡∏° Units:</span>
                                    <span id="weeklyTotalUnits" class="font-bold text-indigo-600">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (Radio) -->
                    <div class="p-3 bg-green-50 rounded-lg border border-green-200 form-section">
                        <p class="text-[10px] sm:text-xs font-bold text-green-600 mb-2 sm:mb-3 uppercase">üè¶ ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</p>
                        
                        <!-- Radio Options -->
                        <div class="space-y-1.5 sm:space-y-2">
                            <label class="flex items-center p-2 sm:p-3 bg-white rounded-lg border-2 cursor-pointer transition hover:border-green-400" id="radioAutoLabel">
                                <input type="radio" name="emergencyType" value="auto" checked class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-green-600 border-gray-300 focus:ring-green-500 flex-shrink-0" onchange="toggleEmergencyMode()">
                                <div class="ml-2 sm:ml-3 flex-1 min-w-0">
                                    <span class="text-xs sm:text-sm font-medium text-gray-800">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
                                    <p class="text-[9px] sm:text-xs text-gray-500 truncate">= ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô - ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ - DCA</p>
                                </div>
                                <span id="autoEmergencyValue" class="text-sm sm:text-lg font-bold text-green-600 flex-shrink-0">‡∏ø0</span>
                            </label>
                            
                            <label class="flex items-center p-2 sm:p-3 bg-white rounded-lg border-2 cursor-pointer transition hover:border-green-400" id="radioCustomLabel">
                                <input type="radio" name="emergencyType" value="custom" class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-green-600 border-gray-300 focus:ring-green-500 flex-shrink-0" onchange="toggleEmergencyMode()">
                                <div class="ml-2 sm:ml-3 flex-1 min-w-0">
                                    <span class="text-xs sm:text-sm font-medium text-gray-800">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</span>
                                    <p class="text-[9px] sm:text-xs text-gray-500">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°</p>
                                </div>
                            </label>
                        </div>
                        
                        <!-- Custom Input (hidden by default) -->
                        <div id="customEmergencySection" class="mt-2 sm:mt-3 hidden">
                            <label class="block text-[10px] sm:text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" id="inputEmergency" placeholder="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 border p-1.5 sm:p-2 text-sm">
                            <p id="emergencyWarning" class="text-[9px] sm:text-xs text-orange-500 mt-1 hidden"></p>
                        </div>
                        
                        <!-- Summary Box -->
                        <div class="mt-2 sm:mt-3 p-2 sm:p-3 bg-green-100 rounded-lg">
                            <div class="flex justify-between text-[10px] sm:text-sm">
                                <span class="text-gray-600">‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢+DCA:</span>
                                <span id="remainingDisplay" class="font-bold text-gray-800">‡∏ø0</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2 pt-2">
                        <button type="submit" class="flex-1 bg-indigo-600 text-white py-1.5 sm:py-2 px-3 sm:px-4 rounded-md hover:bg-indigo-700 transition text-sm sm:text-base">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        <button type="button" onclick="resetForm()" class="px-3 sm:px-4 py-1.5 sm:py-2 border border-gray-300 rounded-md hover:bg-gray-50 text-gray-600 text-sm sm:text-base">‡∏•‡πâ‡∏≤‡∏á</button>
                    </div>
                </form>
            </div>
        </aside>

        <section class="w-full lg:w-2/3 space-y-4 sm:space-y-6">
            
            <div class="bg-white rounded-xl p-3 sm:p-6 shadow-sm border border-gray-100 card-mobile">
                <h2 class="text-sm sm:text-lg font-semibold mb-3 sm:mb-4">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</h2>
                <div class="h-48 sm:h-80 w-full">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden card-mobile">
                <div class="px-3 sm:px-6 py-3 sm:py-4 border-b border-gray-100 flex justify-between items-center">
                    <h2 class="text-sm sm:text-lg font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>
                    <span class="text-[9px] sm:text-xs text-gray-400 hidden sm:inline">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-[10px] sm:text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-1.5 sm:px-4 py-2 sm:py-3 text-left text-[9px] sm:text-xs font-medium text-gray-500 uppercase">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                <th class="px-1.5 sm:px-4 py-2 sm:py-3 text-right text-[9px] sm:text-xs font-medium text-purple-600 uppercase hidden sm:table-cell">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                <th class="px-1.5 sm:px-4 py-2 sm:py-3 text-right text-[9px] sm:text-xs font-medium text-green-600 uppercase">‡∏≠‡∏≠‡∏°</th>
                                <th class="px-1.5 sm:px-4 py-2 sm:py-3 text-right text-[9px] sm:text-xs font-medium text-red-500 uppercase hidden sm:table-cell">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</th>
                                <th class="px-1.5 sm:px-4 py-2 sm:py-3 text-right text-[9px] sm:text-xs font-medium text-blue-600 uppercase">DCA</th>
                                <th class="px-1.5 sm:px-4 py-2 sm:py-3 text-right text-[9px] sm:text-xs font-medium text-gray-500 uppercase">NAV</th>
                                <th class="px-1.5 sm:px-4 py-2 sm:py-3 text-right text-[9px] sm:text-xs font-medium text-cyan-600 uppercase">Units</th>
                                <th class="px-1.5 sm:px-4 py-2 sm:py-3 text-center text-[9px] sm:text-xs font-medium text-gray-500 uppercase"></th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA87Jp9YJWZtz-SXFzInXPhMa6ptlZ6EwQ",
            authDomain: "wealth-tracker-7ff8c.firebaseapp.com",
            projectId: "wealth-tracker-7ff8c",
            storageBucket: "wealth-tracker-7ff8c.firebasestorage.app",
            messagingSenderId: "223313325112",
            appId: "1:223313325112:web:c5366d94d3a24d1c2acacd",
            measurementId: "G-YPC6L2QLWW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let unsubscribeSnapshot = null;

        // Make functions globally available
        window.signInWithGoogle = async function() {
            try {
                const result = await signInWithPopup(auth, provider);
                showNotification('‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            } catch (error) {
                console.error('Sign in error:', error);
                showNotification('‚ùå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message);
            }
        };

        window.signOutUser = async function() {
            try {
                await signOut(auth);
                showNotification('üëã ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
            } catch (error) {
                console.error('Sign out error:', error);
            }
        };

        // Save data to Firestore
        async function saveToCloud(data) {
            if (!currentUser) return;
            try {
                await setDoc(doc(db, "users", currentUser.uid), {
                    records: data,
                    updatedAt: new Date().toISOString()
                });
                updateSyncStatus('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (error) {
                console.error('Save error:', error);
                updateSyncStatus('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        }

        // Load data from Firestore
        async function loadFromCloud() {
            if (!currentUser) return null;
            try {
                const docRef = doc(db, "users", currentUser.uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data().records || [];
                }
                return null;
            } catch (error) {
                console.error('Load error:', error);
                return null;
            }
        }

        // Real-time listener for data sync
        function setupRealtimeSync() {
            if (!currentUser || unsubscribeSnapshot) return;
            
            const docRef = doc(db, "users", currentUser.uid);
            unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const cloudData = docSnap.data().records || [];
                    // Only update if different from current records
                    if (JSON.stringify(cloudData) !== JSON.stringify(window.records)) {
                        window.records = cloudData;
                        localStorage.setItem('wealthData', JSON.stringify(cloudData));
                        window.renderDashboard();
                        updateSyncStatus('üîÑ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• sync ‡πÅ‡∏•‡πâ‡∏ß');
                    }
                }
            }, (error) => {
                console.error('Snapshot error:', error);
            });
        }

        function updateSyncStatus(text) {
            const syncText = document.getElementById('syncText');
            if (syncText) {
                syncText.textContent = text;
                setTimeout(() => {
                    if (currentUser) {
                        syncText.textContent = '‚òÅÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• sync ‡∏Å‡∏±‡∏ö Cloud';
                    }
                }, 2000);
            }
        }

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            const signInBtn = document.getElementById('signInBtn');
            const userInfo = document.getElementById('userInfo');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const syncStatus = document.getElementById('syncStatus');

            if (user) {
                currentUser = user;
                
                // Update UI
                signInBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userInfo.classList.add('flex');
                userAvatar.src = user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || 'U');
                userName.textContent = user.displayName || user.email;
                syncStatus.classList.remove('hidden');

                // Load data from cloud
                const cloudData = await loadFromCloud();
                if (cloudData && cloudData.length > 0) {
                    window.records = cloudData;
                    localStorage.setItem('wealthData', JSON.stringify(cloudData));
                    window.renderDashboard();
                    updateSyncStatus('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cloud ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } else if (window.records.length > 0) {
                    // First time login with existing local data - upload to cloud
                    await saveToCloud(window.records);
                    updateSyncStatus('‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Cloud ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }

                // Setup real-time sync
                setupRealtimeSync();

                // Override saveData to also save to cloud
                window.saveDataOriginal = window.saveData;
                window.saveData = function() {
                    window.records.sort((a, b) => new Date(a.month) - new Date(b.month));
                    localStorage.setItem('wealthData', JSON.stringify(window.records));
                    window.renderDashboard();
                    window.resetForm();
                    // Save to cloud
                    saveToCloud(window.records);
                };

            } else {
                currentUser = null;
                
                // Update UI
                signInBtn.classList.remove('hidden');
                userInfo.classList.add('hidden');
                userInfo.classList.remove('flex');
                syncStatus.classList.add('hidden');

                // Unsubscribe from real-time updates
                if (unsubscribeSnapshot) {
                    unsubscribeSnapshot();
                    unsubscribeSnapshot = null;
                }

                // Restore original saveData
                if (window.saveDataOriginal) {
                    window.saveData = window.saveDataOriginal;
                }
            }
        });
    </script>

    <script>
        // --- DATA STRUCTURE & STATE ---
        window.records = [];
        let expenseRowCounter = 0;
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderDashboard();
            addExpenseRow();
            calculateRemaining();
        });

        // --- CORE FUNCTIONS ---

        window.saveData = function() {
            records.sort((a, b) => new Date(a.month) - new Date(b.month));
            localStorage.setItem('wealthData', JSON.stringify(records));
            renderDashboard();
            resetForm();
        }

        function loadData() {
            const stored = localStorage.getItem('wealthData');
            if (stored) {
                window.records = JSON.parse(stored);
            } else {
                window.records = [];
            }
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(records));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "wealth_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    window.records = JSON.parse(e.target.result);
                    saveData();
                    showNotification("‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                } catch (err) {
                    showNotification("‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }
            };
            reader.readAsText(file);
        }

        // --- EXPENSE MANAGEMENT ---

        function addExpenseRow(name = '', amount = '') {
            const container = document.getElementById('expenseContainer');
            const rowId = `expense_${expenseRowCounter++}`;
            
            const row = document.createElement('div');
            row.className = 'flex gap-1 sm:gap-2 items-center';
            row.id = rowId;
            row.innerHTML = `
                <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" value="${name}" 
                    class="flex-1 min-w-0 rounded-md border-gray-300 border p-1.5 sm:p-2 text-xs sm:text-sm focus:border-orange-500" 
                    oninput="calculateRemaining()">
                <input type="number" placeholder="0" value="${amount}" step="0.01"
                    class="w-20 sm:w-28 rounded-md border-gray-300 border p-1.5 sm:p-2 text-xs sm:text-sm text-right focus:border-orange-500" 
                    oninput="calculateRemaining()">
                <button type="button" onclick="removeExpenseRow('${rowId}')" 
                    class="w-7 h-7 sm:w-8 sm:h-8 flex items-center justify-center bg-red-100 text-red-500 rounded hover:bg-red-500 hover:text-white transition flex-shrink-0">
                    <i class="fas fa-times text-xs"></i>
                </button>
            `;
            container.appendChild(row);
            calculateRemaining();
        }

        function removeExpenseRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                calculateRemaining();
            }
        }

        function getExpenseItems() {
            const items = [];
            document.querySelectorAll('#expenseContainer > div').forEach(row => {
                const inputs = row.querySelectorAll('input');
                const name = inputs[0].value.trim();
                const amount = parseFloat(inputs[1].value) || 0;
                if (name && amount > 0) {
                    items.push({ name, amount });
                }
            });
            return items;
        }

        function getTotalExpenses() {
            let total = 0;
            document.querySelectorAll('#expenseContainer > div').forEach(row => {
                const amountInput = row.querySelectorAll('input')[1];
                total += parseFloat(amountInput.value) || 0;
            });
            return total;
        }

        // --- DCA MODE FUNCTIONS ---

        function toggleDCAMode() {
            const isWeekly = document.getElementById('weeklyMode').checked;
            const monthlySection = document.getElementById('monthlyDCASection');
            const weeklySection = document.getElementById('weeklyDCASection');
            
            if (isWeekly) {
                monthlySection.classList.add('hidden');
                weeklySection.classList.remove('hidden');
                generateWeeklyInputs();
            } else {
                monthlySection.classList.remove('hidden');
                weeklySection.classList.add('hidden');
            }
            calculateRemaining();
        }

        function getWednesdaysInMonth(year, month) {
            const wednesdays = [];
            const date = new Date(year, month - 1, 1);
            
            // Find first Wednesday
            while (date.getDay() !== 3) {
                date.setDate(date.getDate() + 1);
            }
            
            // Get all Wednesdays in the month
            while (date.getMonth() === month - 1) {
                wednesdays.push(new Date(date));
                date.setDate(date.getDate() + 7);
            }
            
            return wednesdays;
        }

        function formatThaiDate(date) {
            const days = ['‡∏≠‡∏≤.', '‡∏à.', '‡∏≠.', '‡∏û.', '‡∏û‡∏§.', '‡∏®.', '‡∏™.'];
            const day = date.getDate();
            const month = date.getMonth() + 1;
            return `‡∏û. ${day}/${month}`;
        }

        function generateWeeklyInputs() {
            const monthInput = document.getElementById('inputMonth').value;
            if (!monthInput) {
                document.getElementById('weeklyInputs').innerHTML = '<p class="text-[10px] sm:text-sm text-gray-400 text-center py-3 sm:py-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</p>';
                document.getElementById('wednesdayCount').textContent = '0 ‡∏ß‡∏±‡∏ô';
                return;
            }
            
            const [year, month] = monthInput.split('-').map(Number);
            const wednesdays = getWednesdaysInMonth(year, month);
            const container = document.getElementById('weeklyInputs');
            const weeklyAmount = parseFloat(document.getElementById('weeklyAmount').value) || 1000;
            
            document.getElementById('wednesdayCount').textContent = `${wednesdays.length} ‡∏ß‡∏±‡∏ô`;
            
            container.innerHTML = wednesdays.map((wed, index) => `
                <div class="flex gap-1 sm:gap-2 items-center bg-white p-1.5 sm:p-2 rounded-lg border border-indigo-100 weekly-input-row">
                    <span class="text-[9px] sm:text-xs text-gray-500 w-12 sm:w-16 flex-shrink-0">${formatThaiDate(wed)}</span>
                    <input type="number" value="${weeklyAmount}" step="0.01" 
                        class="w-14 sm:w-20 text-[10px] sm:text-sm border-gray-300 rounded border p-1 text-right weekly-amount" 
                        oninput="updateWeeklyTotal()">
                    <span class="text-[9px] sm:text-xs text-gray-400 hidden sm:inline">‡∏ö‡∏≤‡∏ó</span>
                    <span class="text-[9px] sm:text-xs text-gray-400">NAV:</span>
                    <input type="number" placeholder="27.50" step="0.0001" 
                        class="w-14 sm:w-20 text-[10px] sm:text-sm border-gray-300 rounded border p-1 text-right weekly-nav" 
                        oninput="updateWeeklyTotal()">
                </div>
            `).join('');
            
            updateWeeklyTotal();
        }

        function updateWeeklyTotal() {
            const amounts = document.querySelectorAll('.weekly-amount');
            const navs = document.querySelectorAll('.weekly-nav');
            
            let totalDCA = 0;
            let totalUnits = 0;
            
            amounts.forEach((amountInput, index) => {
                const amount = parseFloat(amountInput.value) || 0;
                const nav = parseFloat(navs[index]?.value) || 0;
                
                totalDCA += amount;
                if (nav > 0) {
                    totalUnits += amount / nav;
                }
            });
            
            document.getElementById('weeklyTotalDCA').textContent = `‡∏ø${totalDCA.toLocaleString()}`;
            document.getElementById('weeklyTotalUnits').textContent = totalUnits.toFixed(4);
            
            // Update hidden fields for form submission
            document.getElementById('inputDCA').value = totalDCA;
            
            // Calculate weighted average NAV
            if (totalUnits > 0) {
                const avgNAV = totalDCA / totalUnits;
                document.getElementById('inputIndexPrice').value = avgNAV.toFixed(4);
            }
            
            calculateRemaining();
        }

        // Update weekly inputs when month changes
        document.getElementById('inputMonth')?.addEventListener('change', function() {
            if (document.getElementById('weeklyMode').checked) {
                generateWeeklyInputs();
            }
        });

        // --- CALCULATION ---

        function calculateRemaining() {
            const salary = parseFloat(document.getElementById('inputSalary').value) || 0;
            const totalExpenses = getTotalExpenses();
            const dca = parseFloat(document.getElementById('inputDCA').value) || 0;
            
            const remaining = salary - totalExpenses - dca;
            
            document.getElementById('totalExpenseDisplay').textContent = `‡∏ø${totalExpenses.toLocaleString()}`;
            document.getElementById('remainingDisplay').textContent = `‡∏ø${remaining.toLocaleString()}`;
            document.getElementById('autoEmergencyValue').textContent = `‡∏ø${Math.max(0, remaining).toLocaleString()}`;
            
            const remainingEl = document.getElementById('remainingDisplay');
            if (remaining < 0) {
                remainingEl.classList.remove('text-gray-800', 'text-green-600');
                remainingEl.classList.add('text-red-500');
            } else {
                remainingEl.classList.remove('text-red-500');
                remainingEl.classList.add('text-green-600');
            }
            
            const emergencyType = document.querySelector('input[name="emergencyType"]:checked').value;
            if (emergencyType === 'custom') {
                const customAmount = parseFloat(document.getElementById('inputEmergency').value) || 0;
                const warningEl = document.getElementById('emergencyWarning');
                if (customAmount > remaining) {
                    warningEl.textContent = `‚ö†Ô∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (${remaining.toLocaleString()} ‡∏ö‡∏≤‡∏ó)`;
                    warningEl.classList.remove('hidden');
                } else {
                    warningEl.classList.add('hidden');
                }
            }
        }

        function toggleEmergencyMode() {
            const emergencyType = document.querySelector('input[name="emergencyType"]:checked').value;
            const customSection = document.getElementById('customEmergencySection');
            const autoLabel = document.getElementById('radioAutoLabel');
            const customLabel = document.getElementById('radioCustomLabel');
            
            if (emergencyType === 'custom') {
                customSection.classList.remove('hidden');
                autoLabel.classList.remove('border-green-500');
                autoLabel.classList.add('border-gray-200');
                customLabel.classList.remove('border-gray-200');
                customLabel.classList.add('border-green-500');
            } else {
                customSection.classList.add('hidden');
                autoLabel.classList.remove('border-gray-200');
                autoLabel.classList.add('border-green-500');
                customLabel.classList.remove('border-green-500');
                customLabel.classList.add('border-gray-200');
            }
            calculateRemaining();
        }

        // --- FORM HANDLING ---

        const form = document.getElementById('dataForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const editIndex = document.getElementById('editIndex').value;
            
            const salary = parseFloat(document.getElementById('inputSalary').value) || 0;
            const expenses = getExpenseItems();
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
            const dca = parseFloat(document.getElementById('inputDCA').value) || 0;
            const remaining = salary - totalExpenses - dca;
            
            const emergencyType = document.querySelector('input[name="emergencyType"]:checked').value;
            let emergency;
            if (emergencyType === 'auto') {
                emergency = Math.max(0, remaining);
            } else {
                emergency = parseFloat(document.getElementById('inputEmergency').value) || 0;
            }
            
            // Check if weekly mode and collect weekly data
            const isWeeklyMode = document.getElementById('weeklyMode').checked;
            let weeklyData = null;
            
            if (isWeeklyMode) {
                const amounts = document.querySelectorAll('.weekly-amount');
                const navs = document.querySelectorAll('.weekly-nav');
                weeklyData = [];
                
                amounts.forEach((amountInput, index) => {
                    const amount = parseFloat(amountInput.value) || 0;
                    const nav = parseFloat(navs[index]?.value) || 0;
                    if (amount > 0) {
                        weeklyData.push({ amount, nav });
                    }
                });
            }
            
            const newRecord = {
                month: document.getElementById('inputMonth').value,
                salary: salary,
                emergency: emergency,
                expenses: expenses,
                dca: dca,
                indexPrice: parseFloat(document.getElementById('inputIndexPrice').value) || 0,
                weeklyMode: isWeeklyMode,
                weeklyData: weeklyData
            };

            if (editIndex !== "") {
                window.records[editIndex] = newRecord;
            } else {
                const existing = window.records.findIndex(r => r.month === newRecord.month);
                if (existing >= 0) {
                    if(!confirm("‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
                    window.records[existing] = newRecord;
                } else {
                    window.records.push(newRecord);
                }
            }
            saveData();
        });

        function editRecord(index) {
            const r = window.records[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('inputMonth').value = r.month;
            document.getElementById('inputSalary').value = r.salary || 0;
            document.getElementById('inputDCA').value = r.dca;
            document.getElementById('inputIndexPrice').value = r.indexPrice;
            
            document.getElementById('expenseContainer').innerHTML = '';
            expenseRowCounter = 0;
            
            if (r.expenses && Array.isArray(r.expenses)) {
                r.expenses.forEach(exp => addExpenseRow(exp.name, exp.amount));
            } else if (r.expense) {
                addExpenseRow('‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', r.expense);
            }
            
            if (document.querySelectorAll('#expenseContainer > div').length === 0) {
                addExpenseRow();
            }
            
            // Restore weekly mode if applicable
            if (r.weeklyMode && r.weeklyData) {
                document.getElementById('weeklyMode').checked = true;
                toggleDCAMode();
                
                // Wait for inputs to be generated then fill them
                setTimeout(() => {
                    const amounts = document.querySelectorAll('.weekly-amount');
                    const navs = document.querySelectorAll('.weekly-nav');
                    
                    r.weeklyData.forEach((data, i) => {
                        if (amounts[i]) amounts[i].value = data.amount;
                        if (navs[i]) navs[i].value = data.nav;
                    });
                    updateWeeklyTotal();
                }, 100);
            } else {
                document.getElementById('weeklyMode').checked = false;
                toggleDCAMode();
            }
            
            const salary = r.salary || 0;
            const totalExpenses = r.expenses ? r.expenses.reduce((sum, e) => sum + e.amount, 0) : (r.expense || 0);
            const remaining = salary - totalExpenses - r.dca;
            
            if (Math.abs(r.emergency - Math.max(0, remaining)) < 1) {
                document.querySelector('input[name="emergencyType"][value="auto"]').checked = true;
            } else {
                document.querySelector('input[name="emergencyType"][value="custom"]').checked = true;
                document.getElementById('inputEmergency').value = r.emergency;
            }
            toggleEmergencyMode();
            calculateRemaining();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteRecord(index) {
            if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ?')) {
                window.records.splice(index, 1);
                saveData();
            }
        }

        function duplicateRecord(index) {
            const r = window.records[index];
            
            document.getElementById('editIndex').value = "";
            
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('inputMonth').value = currentMonth;
            
            document.getElementById('inputSalary').value = r.salary || 0;
            document.getElementById('inputDCA').value = r.dca;
            document.getElementById('inputIndexPrice').value = r.indexPrice;
            
            document.getElementById('expenseContainer').innerHTML = '';
            expenseRowCounter = 0;
            
            if (r.expenses && Array.isArray(r.expenses)) {
                r.expenses.forEach(exp => addExpenseRow(exp.name, exp.amount));
            } else if (r.expense) {
                addExpenseRow('‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', r.expense);
            }
            
            if (document.querySelectorAll('#expenseContainer > div').length === 0) {
                addExpenseRow();
            }
            
            const salary = r.salary || 0;
            const totalExpenses = r.expenses ? r.expenses.reduce((sum, e) => sum + e.amount, 0) : (r.expense || 0);
            const remaining = salary - totalExpenses - r.dca;
            
            if (Math.abs(r.emergency - Math.max(0, remaining)) < 1) {
                document.querySelector('input[name="emergencyType"][value="auto"]').checked = true;
            } else {
                document.querySelector('input[name="emergencyType"][value="custom"]').checked = true;
                document.getElementById('inputEmergency').value = r.emergency;
            }
            toggleEmergencyMode();
            calculateRemaining();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showNotification('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà');
        }

        window.showNotification = function(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-indigo-600 text-white px-4 py-3 rounded-lg shadow-lg z-50 animate-pulse';
            notification.innerHTML = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transition = 'opacity 0.3s';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        window.resetForm = function() {
            form.reset();
            document.getElementById('editIndex').value = "";
            document.getElementById('expenseContainer').innerHTML = '';
            expenseRowCounter = 0;
            addExpenseRow();
            document.querySelector('input[name="emergencyType"][value="auto"]').checked = true;
            toggleEmergencyMode();
            
            // Reset weekly mode
            document.getElementById('weeklyMode').checked = false;
            document.getElementById('monthlyDCASection').classList.remove('hidden');
            document.getElementById('weeklyDCASection').classList.add('hidden');
            document.getElementById('weeklyInputs').innerHTML = '';
            
            calculateRemaining();
        }

        // --- RENDERING & CHARTS ---

        let myChart = null;

        function getRecordTotalExpenses(r) {
            if (r.expenses && Array.isArray(r.expenses)) {
                return r.expenses.reduce((sum, e) => sum + e.amount, 0);
            }
            return r.expense || 0;
        }

        function isFutureMonth(monthStr) {
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            return monthStr > currentMonth;
        }

        function getCurrentMonth() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }

        window.renderDashboard = function() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            let totalInvestedTHB = 0;
            let totalUnits = 0;

            window.records.forEach((r, index) => {
                const totalExpense = getRecordTotalExpenses(r);
                const isFuture = isFutureMonth(r.month);
                
                // Calculate units: DCA (‡∏ö‡∏≤‡∏ó) / NAV (‡∏ö‡∏≤‡∏ó) = Units
                let rowUnits = 0;
                if (r.dca > 0 && r.indexPrice > 0) {
                    rowUnits = r.dca / r.indexPrice;
                }
                
                const tr = document.createElement('tr');
                
                if (isFuture) {
                    tr.className = "bg-gray-100 opacity-60 cursor-pointer transition hover:opacity-80";
                } else {
                    tr.className = "hover:bg-gray-50 cursor-pointer transition";
                }
                
                tr.onclick = (e) => { if(e.target.tagName !== 'BUTTON' && e.target.tagName !== 'I') editRecord(index); };
                
                let expenseDisplay = totalExpense.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                if (r.expenses && r.expenses.length > 1) {
                    const expenseList = r.expenses.map(e => `${e.name}: ‡∏ø${e.amount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`).join('\n');
                    expenseDisplay = `<span title="${expenseList}" class="cursor-help border-b border-dashed border-gray-400">${totalExpense.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>`;
                }
                
                let monthDisplay = r.month;
                if (isFuture) {
                    monthDisplay = `${r.month} <span class="ml-1 px-1 py-0.5 bg-yellow-100 text-yellow-700 text-[8px] sm:text-xs rounded font-medium hidden sm:inline">üìÖ ‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</span>`;
                }
                
                let unitsDisplay = rowUnits > 0 ? rowUnits.toFixed(4) : '-';
                
                tr.innerHTML = `
                    <td class="px-1.5 sm:px-4 py-2 sm:py-4 whitespace-nowrap font-medium text-[10px] sm:text-sm ${isFuture ? 'text-gray-500' : 'text-gray-900'}">${monthDisplay}</td>
                    <td class="px-1.5 sm:px-4 py-2 sm:py-4 whitespace-nowrap text-right text-[10px] sm:text-sm ${isFuture ? 'text-gray-400' : 'text-purple-600'} hidden sm:table-cell">${(r.salary || 0).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                    <td class="px-1.5 sm:px-4 py-2 sm:py-4 whitespace-nowrap text-right text-[10px] sm:text-sm ${isFuture ? 'text-gray-400' : 'text-green-600'}">${r.emergency.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                    <td class="px-1.5 sm:px-4 py-2 sm:py-4 whitespace-nowrap text-right text-[10px] sm:text-sm ${isFuture ? 'text-gray-400' : 'text-red-500'} hidden sm:table-cell">${expenseDisplay}</td>
                    <td class="px-1.5 sm:px-4 py-2 sm:py-4 whitespace-nowrap text-right text-[10px] sm:text-sm ${isFuture ? 'text-gray-400' : 'text-blue-600'} font-medium">${r.dca.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                    <td class="px-1.5 sm:px-4 py-2 sm:py-4 whitespace-nowrap text-right text-[10px] sm:text-sm text-gray-500">${r.indexPrice > 0 ? r.indexPrice.toFixed(2) : '-'}</td>
                    <td class="px-1.5 sm:px-4 py-2 sm:py-4 whitespace-nowrap text-right text-[10px] sm:text-sm ${isFuture ? 'text-gray-400' : 'text-cyan-600'} font-mono">${unitsDisplay}</td>
                    <td class="px-1 sm:px-4 py-2 sm:py-4 whitespace-nowrap text-center font-medium">
                        <button onclick="duplicateRecord(${index})" class="text-indigo-600 hover:text-indigo-900 p-1" title="Duplicate"><i class="fas fa-copy text-[10px] sm:text-sm"></i></button>
                        <button onclick="deleteRecord(${index})" class="text-red-600 hover:text-red-900 p-1" title="Delete"><i class="fas fa-trash text-[10px] sm:text-sm"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);

                if (!isFuture && r.dca > 0 && r.indexPrice > 0) {
                    totalInvestedTHB += r.dca;
                    totalUnits += rowUnits;
                }
            });

            // NAV ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)
            const currentNAV = parseFloat(document.getElementById('currentNAV').value) || 0;
            
            // ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô = Units x NAV ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)
            const currentValueTHB = totalUnits * currentNAV;
            
            const profit = currentValueTHB - totalInvestedTHB;
            const profitPercent = totalInvestedTHB > 0 ? (profit / totalInvestedTHB) * 100 : 0;

            document.getElementById('portValue').innerText = `‡∏ø${currentValueTHB.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            const returnEl = document.getElementById('portReturn');
            returnEl.innerHTML = `<span class="${profit >= 0 ? 'text-green-300' : 'text-red-300'}">${profit >= 0 ? '+' : ''}‡∏ø${profit.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})} (${profit >= 0 ? '+' : ''}${profitPercent.toFixed(1)}%)</span>`;

            document.getElementById('totalUnits').innerText = totalUnits.toFixed(4);
            document.getElementById('totalCost').innerText = `‡∏ø${totalInvestedTHB.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            const validRecords = window.records.filter(r => !isFutureMonth(r.month));
            
            const labels = validRecords.map(r => r.month);
            const dataEmergency = validRecords.map(r => r.emergency);
            const dataDCA = validRecords.map(r => r.dca);
            const dataExpense = validRecords.map(r => getRecordTotalExpenses(r));
            
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô',
                            data: dataEmergency,
                            backgroundColor: '#fbbf24',
                            stack: 'Stack 0',
                        },
                        {
                            label: 'DCA Investment',
                            data: dataDCA,
                            backgroundColor: '#4f46e5',
                            stack: 'Stack 0',
                        },
                        {
                            label: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢',
                            data: dataExpense,
                            type: 'line',
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 3,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false } },
                        y: { stacked: true, beginAtZero: true }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        }
    </script>
</body>
</html>
