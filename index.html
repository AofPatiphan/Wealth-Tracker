<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Wealth Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        
        /* Mobile Responsive Styles */
        @media (max-width: 640px) {
            /* Header */
            header .max-w-7xl { padding: 0.75rem 0.75rem; }
            header h1 { font-size: 1rem; }
            
            /* Portfolio Card */
            .portfolio-card { padding: 1rem !important; }
            .portfolio-card .text-3xl { font-size: 1.5rem !important; }
            .portfolio-card .text-2xl { font-size: 1.25rem !important; }
            .portfolio-card .text-xl { font-size: 1rem !important; }
            
            /* Form sections */
            .form-section { padding: 0.75rem !important; }
            .form-section .text-lg { font-size: 1rem !important; }
            .form-section .text-sm { font-size: 0.8rem !important; }
            .form-section .text-xs { font-size: 0.7rem !important; }
            .form-section input { font-size: 0.875rem !important; padding: 0.5rem !important; }
            .form-section label { font-size: 0.75rem !important; }
            
            /* DCA Toggle */
            .dca-toggle { flex-direction: column; align-items: flex-start !important; gap: 0.5rem; }
            .dca-toggle-label { flex-direction: row; }
            
            /* Buttons */
            .btn-mobile { font-size: 0.8rem !important; padding: 0.5rem 0.75rem !important; }
            
            /* Table */
            table { font-size: 0.75rem !important; }
            table th, table td { padding: 0.5rem 0.25rem !important; }
            
            /* Weekly inputs */
            .weekly-input-row { flex-wrap: wrap; }
            .weekly-input-row input { width: 4rem !important; font-size: 0.75rem !important; }
            .weekly-input-row span { font-size: 0.65rem !important; }
            
            /* Main container */
            main { padding: 0.75rem !important; gap: 1rem !important; }
            
            /* Cards */
            .card-mobile { padding: 1rem !important; }
            .card-mobile h2 { font-size: 1rem !important; }
        }
        
        /* Small phones */
        @media (max-width: 380px) {
            .portfolio-card .text-3xl { font-size: 1.25rem !important; }
            .portfolio-card .grid { gap: 0.5rem !important; }
            .form-section input { height: 2.25rem !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-3 sm:px-4 py-2 sm:py-4 flex justify-between items-center">
            <h1 class="text-base sm:text-xl font-bold text-indigo-600"><i class="fas fa-chart-line mr-1 sm:mr-2"></i><span class="hidden xs:inline">Wealth </span>Tracker</h1>
            <div class="flex items-center space-x-3">
                <!-- Auth UI -->
                <div id="authSection" class="flex items-center space-x-2">
                    <div id="userInfo" class="hidden flex items-center space-x-2">
                        <img id="userAvatar" src="" alt="" class="w-8 h-8 rounded-full border-2 border-indigo-300">
                        <span id="userName" class="text-sm text-gray-600 hidden sm:inline"></span>
                        <button onclick="signOutUser()" class="text-sm text-red-500 hover:text-red-700" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                    <button id="signInBtn" onclick="signInWithGoogle()" class="bg-white border border-gray-300 text-gray-700 px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50 flex items-center space-x-2 shadow-sm">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="w-4 h-4">
                        <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
                    </button>
                </div>
                <div class="border-l pl-3 space-x-2">
                    <button onclick="exportData()" class="text-sm text-gray-500 hover:text-indigo-600"><i class="fas fa-download"></i> <span class="hidden sm:inline">Backup</span></button>
                    <label for="importFile" class="text-sm text-gray-500 hover:text-indigo-600 cursor-pointer"><i class="fas fa-upload"></i> <span class="hidden sm:inline">Restore</span></label>
                    <input type="file" id="importFile" class="hidden" onchange="importData(this)">
                </div>
            </div>
        </div>
        <!-- Sync Status Bar -->
        <div id="syncStatus" class="hidden bg-indigo-50 border-t border-indigo-100 px-4 py-1 text-center text-xs text-indigo-600">
            <i class="fas fa-cloud"></i> <span id="syncText">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• sync ‡∏Å‡∏±‡∏ö Cloud</span>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto px-2 sm:px-4 py-3 sm:py-6 w-full gap-4 sm:gap-6 flex flex-col lg:flex-row">
        
        <aside class="w-full lg:w-1/3 space-y-4 sm:space-y-6">
            
            <div class="bg-indigo-600 rounded-xl p-4 sm:p-6 text-white shadow-lg portfolio-card">
                <div class="flex justify-between items-start gap-2">
                    <div class="flex-1 min-w-0">
                        <p class="text-indigo-200 text-[10px] sm:text-sm">üìä ‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô</p>
                        <p class="text-lg sm:text-2xl font-bold mt-1 truncate" id="portValue">‡∏ø0.00</p>
                    </div>
                    <div class="text-right flex-1 min-w-0">
                        <p class="text-indigo-200 text-[10px] sm:text-sm">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</p>
                        <p class="text-base sm:text-xl font-bold mt-1 truncate" id="portReturn">‡∏ø0</p>
                        <p class="text-[10px] sm:text-xs text-indigo-300" id="portReturnPercent">0%</p>
                    </div>
                </div>
                <!-- Total Stats -->
                <div class="mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-indigo-500 grid grid-cols-2 gap-2 sm:gap-4">
                    <div>
                        <p class="text-indigo-200 text-[10px] sm:text-xs">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</p>
                        <p class="text-base sm:text-xl font-bold mt-0.5 sm:mt-1 truncate" id="totalCost">‡∏ø0</p>
                    </div>
                    <div class="text-right">
                        <p class="text-indigo-200 text-[10px] sm:text-xs">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô</p>
                        <p class="text-base sm:text-xl font-bold mt-0.5 sm:mt-1" id="fundCount">0</p>
                    </div>
                </div>
                <!-- Investment Breakdown -->
                <div id="investmentBreakdown" class="mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-indigo-500 space-y-2 max-h-32 overflow-y-auto">
                    <!-- Investment items will be rendered here -->
                </div>
                <!-- NAV Update Button -->
                <button onclick="openNAVModal()" class="mt-3 w-full py-1.5 bg-indigo-500 hover:bg-indigo-400 rounded text-[10px] sm:text-sm transition">
                    <i class="fas fa-sync-alt mr-1"></i> ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó NAV ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                </button>
            </div>

            <div class="bg-white rounded-xl p-4 sm:p-6 shadow-sm border border-gray-100 card-mobile">
                <h2 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 border-b pb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
                <form id="dataForm" class="space-y-4">
                    <input type="hidden" id="editIndex">
                    
                    <!-- ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -->
                    <div class="grid grid-cols-2 gap-2 sm:gap-4">
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ</label>
                            <input type="month" id="inputMonth" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-1.5 sm:p-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" id="inputSalary" placeholder="40,000" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 border p-1.5 sm:p-2 text-sm" oninput="calculateRemaining()">
                        </div>
                    </div>

                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ Dynamic -->
                    <div class="p-3 bg-orange-50 rounded-lg border border-orange-200 form-section">
                        <div class="flex justify-between items-center mb-2 sm:mb-3">
                            <p class="text-[10px] sm:text-xs font-bold text-orange-600 uppercase">üí∏ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</p>
                            <button type="button" onclick="addExpenseRow()" class="text-[10px] sm:text-xs bg-orange-500 text-white px-2 py-1 rounded hover:bg-orange-600 transition">
                                <i class="fas fa-plus mr-1"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°
                            </button>
                        </div>
                        <div id="expenseContainer" class="space-y-2">
                            <!-- Dynamic expense rows will be added here -->
                        </div>
                        <button type="button" onclick="addExpenseRow()" class="mt-2 w-full py-1.5 sm:py-2 border-2 border-dashed border-orange-300 rounded-md text-orange-500 text-[10px] sm:text-sm hover:bg-orange-100 transition">
                            <i class="fas fa-plus mr-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
                        </button>
                        
                        <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° -->
                        <div class="mt-2 sm:mt-3 pt-2 sm:pt-3 border-t border-orange-200 flex justify-between items-center">
                            <span class="text-xs sm:text-sm font-medium text-gray-700">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢:</span>
                            <span id="totalExpenseDisplay" class="text-sm sm:text-lg font-bold text-red-500">‡∏ø0</span>
                        </div>
                    </div>

                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô DCA (Multi-Investment) -->
                    <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-200 form-section">
                        <div class="flex justify-between items-center mb-2 sm:mb-3">
                            <p class="text-[10px] sm:text-xs font-bold text-indigo-600 uppercase">üìà ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô DCA</p>
                            <button type="button" onclick="addInvestmentRow()" class="text-[10px] sm:text-xs bg-indigo-500 text-white px-2 py-1 rounded hover:bg-indigo-600 transition">
                                <i class="fas fa-plus mr-1"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°
                            </button>
                        </div>
                        
                        <div id="investmentContainer" class="space-y-2">
                            <!-- Investment rows will be added here -->
                        </div>
                        
                        <button type="button" onclick="addInvestmentRow()" class="mt-2 w-full py-1.5 sm:py-2 border-2 border-dashed border-indigo-300 rounded-md text-indigo-500 text-[10px] sm:text-sm hover:bg-indigo-100 transition">
                            <i class="fas fa-plus mr-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô
                        </button>
                        
                        <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° -->
                        <div class="mt-2 sm:mt-3 pt-2 sm:pt-3 border-t border-indigo-200 flex justify-between items-center">
                            <span class="text-xs sm:text-sm font-medium text-gray-700">‡∏£‡∏ß‡∏° DCA:</span>
                            <span id="totalInvestmentDisplay" class="text-sm sm:text-lg font-bold text-indigo-600">‡∏ø0</span>
                        </div>
                    </div>

                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (Radio) -->
                    <div class="p-3 bg-green-50 rounded-lg border border-green-200 form-section">
                        <p class="text-[10px] sm:text-xs font-bold text-green-600 mb-2 sm:mb-3 uppercase">üè¶ ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</p>
                        
                        <!-- Radio Options -->
                        <div class="space-y-1.5 sm:space-y-2">
                            <label class="flex items-center p-2 sm:p-3 bg-white rounded-lg border-2 cursor-pointer transition hover:border-green-400" id="radioAutoLabel">
                                <input type="radio" name="emergencyType" value="auto" checked class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-green-600 border-gray-300 focus:ring-green-500 flex-shrink-0" onchange="toggleEmergencyMode()">
                                <div class="ml-2 sm:ml-3 flex-1 min-w-0">
                                    <span class="text-xs sm:text-sm font-medium text-gray-800">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
                                    <p class="text-[9px] sm:text-xs text-gray-500 truncate">= ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô - ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ - DCA</p>
                                </div>
                                <span id="autoEmergencyValue" class="text-sm sm:text-lg font-bold text-green-600 flex-shrink-0">‡∏ø0</span>
                            </label>
                            
                            <label class="flex items-center p-2 sm:p-3 bg-white rounded-lg border-2 cursor-pointer transition hover:border-green-400" id="radioCustomLabel">
                                <input type="radio" name="emergencyType" value="custom" class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-green-600 border-gray-300 focus:ring-green-500 flex-shrink-0" onchange="toggleEmergencyMode()">
                                <div class="ml-2 sm:ml-3 flex-1 min-w-0">
                                    <span class="text-xs sm:text-sm font-medium text-gray-800">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</span>
                                    <p class="text-[9px] sm:text-xs text-gray-500">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°</p>
                                </div>
                            </label>
                        </div>
                        
                        <!-- Custom Input (hidden by default) -->
                        <div id="customEmergencySection" class="mt-2 sm:mt-3 hidden">
                            <label class="block text-[10px] sm:text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" id="inputEmergency" placeholder="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 border p-1.5 sm:p-2 text-sm">
                            <p id="emergencyWarning" class="text-[9px] sm:text-xs text-orange-500 mt-1 hidden"></p>
                        </div>
                        
                        <!-- Summary Box -->
                        <div class="mt-2 sm:mt-3 p-2 sm:p-3 bg-green-100 rounded-lg">
                            <div class="flex justify-between text-[10px] sm:text-sm">
                                <span class="text-gray-600">‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢+DCA:</span>
                                <span id="remainingDisplay" class="font-bold text-gray-800">‡∏ø0</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2 pt-2">
                        <button type="submit" class="flex-1 bg-indigo-600 text-white py-1.5 sm:py-2 px-3 sm:px-4 rounded-md hover:bg-indigo-700 transition text-sm sm:text-base">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        <button type="button" onclick="resetForm()" class="px-3 sm:px-4 py-1.5 sm:py-2 border border-gray-300 rounded-md hover:bg-gray-50 text-gray-600 text-sm sm:text-base">‡∏•‡πâ‡∏≤‡∏á</button>
                    </div>
                </form>
            </div>
        </aside>

        <section class="w-full lg:w-2/3 space-y-4 sm:space-y-6">
            
            <div class="bg-white rounded-xl p-3 sm:p-6 shadow-sm border border-gray-100 card-mobile">
                <h2 class="text-sm sm:text-lg font-semibold mb-3 sm:mb-4">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</h2>
                <div class="h-48 sm:h-80 w-full">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden card-mobile">
                <div class="px-3 sm:px-6 py-3 sm:py-4 border-b border-gray-100 flex justify-between items-center">
                    <h2 class="text-sm sm:text-lg font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>
                    <span class="text-[9px] sm:text-xs text-gray-400 hidden sm:inline">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-[10px] sm:text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-1.5 sm:px-4 py-2 sm:py-3 text-left text-[9px] sm:text-xs font-medium text-gray-500 uppercase">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                <th class="px-1.5 sm:px-4 py-2 sm:py-3 text-right text-[9px] sm:text-xs font-medium text-purple-600 uppercase hidden sm:table-cell">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                <th class="px-1.5 sm:px-4 py-2 sm:py-3 text-right text-[9px] sm:text-xs font-medium text-green-600 uppercase">‡∏≠‡∏≠‡∏°</th>
                                <th class="px-1.5 sm:px-4 py-2 sm:py-3 text-right text-[9px] sm:text-xs font-medium text-red-500 uppercase hidden sm:table-cell">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</th>
                                <th class="px-1.5 sm:px-4 py-2 sm:py-3 text-right text-[9px] sm:text-xs font-medium text-indigo-600 uppercase">‡∏•‡∏á‡∏ó‡∏∏‡∏ô</th>
                                <th class="px-1.5 sm:px-4 py-2 sm:py-3 text-left text-[9px] sm:text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô</th>
                                <th class="px-1.5 sm:px-4 py-2 sm:py-3 text-center text-[9px] sm:text-xs font-medium text-gray-500 uppercase"></th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- NAV Update Modal -->
    <div id="navModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[80vh] overflow-hidden">
            <div class="px-4 py-3 border-b bg-indigo-50 flex justify-between items-center">
                <h3 class="font-semibold text-indigo-800"><i class="fas fa-sync-alt mr-2"></i>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó NAV ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
                <button onclick="closeNAVModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="navModalContent" class="p-4 space-y-3 max-h-[60vh] overflow-y-auto">
                <!-- NAV inputs will be rendered here -->
            </div>
            <div class="px-4 py-3 border-t bg-gray-50 flex justify-end gap-2">
                <button onclick="closeNAVModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveNAVUpdates()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Investment Type Modal (for selecting fund) -->
    <div id="fundSelectModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-sm w-full">
            <div class="px-4 py-3 border-b bg-indigo-50 flex justify-between items-center">
                <h3 class="font-semibold text-indigo-800"><i class="fas fa-list mr-2"></i>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô</h3>
                <button onclick="closeFundSelectModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="fundSelectList" class="p-4 space-y-2 max-h-[50vh] overflow-y-auto">
                <!-- Fund options will be rendered here -->
            </div>
            <div class="px-4 py-3 border-t bg-gray-50">
                <button onclick="showAddNewFundForm()" class="w-full py-2 border-2 border-dashed border-indigo-300 rounded text-indigo-500 text-sm hover:bg-indigo-50">
                    <i class="fas fa-plus mr-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>
    </div>

    <!-- Add New Fund Modal -->
    <div id="addFundModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-sm w-full">
            <div class="px-4 py-3 border-b bg-green-50 flex justify-between items-center">
                <h3 class="font-semibold text-green-800"><i class="fas fa-plus-circle mr-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                <button onclick="closeAddFundModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4 space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô</label>
                    <input type="text" id="newFundName" placeholder="‡πÄ‡∏ä‡πà‡∏ô SCBS&P500E" class="mt-1 w-full border rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">NAV ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" id="newFundNAV" placeholder="28.00" step="0.0001" class="mt-1 w-full border rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡∏™‡∏µ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü)</label>
                    <div class="flex gap-2 mt-1">
                        <input type="color" id="newFundColor" value="#4F46E5" class="w-12 h-10 rounded border cursor-pointer">
                        <input type="text" id="newFundColorText" value="#4F46E5" class="flex-1 border rounded-md p-2 text-sm" onchange="document.getElementById('newFundColor').value = this.value">
                    </div>
                </div>
            </div>
            <div class="px-4 py-3 border-t bg-gray-50 flex justify-end gap-2">
                <button onclick="closeAddFundModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveNewFund()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA87Jp9YJWZtz-SXFzInXPhMa6ptlZ6EwQ",
            authDomain: "wealth-tracker-7ff8c.firebaseapp.com",
            projectId: "wealth-tracker-7ff8c",
            storageBucket: "wealth-tracker-7ff8c.firebasestorage.app",
            messagingSenderId: "223313325112",
            appId: "1:223313325112:web:c5366d94d3a24d1c2acacd",
            measurementId: "G-YPC6L2QLWW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let unsubscribeSnapshot = null;

        // Make functions globally available
        window.signInWithGoogle = async function() {
            try {
                const result = await signInWithPopup(auth, provider);
                showNotification('‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            } catch (error) {
                console.error('Sign in error:', error);
                showNotification('‚ùå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message);
            }
        };

        window.signOutUser = async function() {
            try {
                await signOut(auth);
                showNotification('üëã ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
            } catch (error) {
                console.error('Sign out error:', error);
            }
        };

        // Save data to Firestore
        async function saveToCloud(data) {
            if (!currentUser) return;
            try {
                await setDoc(doc(db, "users", currentUser.uid), {
                    records: data,
                    fundTypes: window.fundTypes,
                    updatedAt: new Date().toISOString()
                });
                updateSyncStatus('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (error) {
                console.error('Save error:', error);
                updateSyncStatus('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        }

        // Load data from Firestore
        async function loadFromCloud() {
            if (!currentUser) return null;
            try {
                const docRef = doc(db, "users", currentUser.uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Also load fund types if available
                    if (data.fundTypes && Array.isArray(data.fundTypes)) {
                        window.fundTypes = data.fundTypes;
                        localStorage.setItem('fundTypes', JSON.stringify(data.fundTypes));
                    }
                    return data.records || [];
                }
                return null;
            } catch (error) {
                console.error('Load error:', error);
                return null;
            }
        }

        // Real-time listener for data sync
        function setupRealtimeSync() {
            if (!currentUser || unsubscribeSnapshot) return;
            
            const docRef = doc(db, "users", currentUser.uid);
            unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const cloudData = data.records || [];
                    const cloudFundTypes = data.fundTypes || [];
                    
                    // Update fund types if different
                    if (cloudFundTypes.length > 0 && JSON.stringify(cloudFundTypes) !== JSON.stringify(window.fundTypes)) {
                        window.fundTypes = cloudFundTypes;
                        localStorage.setItem('fundTypes', JSON.stringify(cloudFundTypes));
                    }
                    
                    // Only update if different from current records
                    if (JSON.stringify(cloudData) !== JSON.stringify(window.records)) {
                        window.records = cloudData;
                        localStorage.setItem('wealthData', JSON.stringify(cloudData));
                        window.renderDashboard();
                        updateSyncStatus('üîÑ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• sync ‡πÅ‡∏•‡πâ‡∏ß');
                    }
                }
            }, (error) => {
                console.error('Snapshot error:', error);
            });
        }

        function updateSyncStatus(text) {
            const syncText = document.getElementById('syncText');
            if (syncText) {
                syncText.textContent = text;
                setTimeout(() => {
                    if (currentUser) {
                        syncText.textContent = '‚òÅÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• sync ‡∏Å‡∏±‡∏ö Cloud';
                    }
                }, 2000);
            }
        }

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            const signInBtn = document.getElementById('signInBtn');
            const userInfo = document.getElementById('userInfo');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const syncStatus = document.getElementById('syncStatus');

            if (user) {
                currentUser = user;
                
                // Update UI
                signInBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userInfo.classList.add('flex');
                userAvatar.src = user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || 'U');
                userName.textContent = user.displayName || user.email;
                syncStatus.classList.remove('hidden');

                // Load data from cloud
                const cloudData = await loadFromCloud();
                if (cloudData && cloudData.length > 0) {
                    window.records = cloudData;
                    localStorage.setItem('wealthData', JSON.stringify(cloudData));
                    window.renderDashboard();
                    updateSyncStatus('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cloud ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } else if (window.records.length > 0) {
                    // First time login with existing local data - upload to cloud
                    await saveToCloud(window.records);
                    updateSyncStatus('‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Cloud ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }

                // Setup real-time sync
                setupRealtimeSync();

                // Override saveData to also save to cloud
                window.saveDataOriginal = window.saveData;
                window.saveData = function() {
                    window.records.sort((a, b) => new Date(a.month) - new Date(b.month));
                    localStorage.setItem('wealthData', JSON.stringify(window.records));
                    window.renderDashboard();
                    window.resetForm();
                    // Save to cloud
                    saveToCloud(window.records);
                };

            } else {
                currentUser = null;
                
                // Update UI
                signInBtn.classList.remove('hidden');
                userInfo.classList.add('hidden');
                userInfo.classList.remove('flex');
                syncStatus.classList.add('hidden');

                // Unsubscribe from real-time updates
                if (unsubscribeSnapshot) {
                    unsubscribeSnapshot();
                    unsubscribeSnapshot = null;
                }

                // Restore original saveData
                if (window.saveDataOriginal) {
                    window.saveData = window.saveDataOriginal;
                }
            }
        });
    </script>

    <script>
        // --- DATA STRUCTURE & STATE ---
        window.records = [];
        let expenseRowCounter = 0;
        let investmentRowCounter = 0;
        let currentSelectingRowId = null;
        
        // Default investment types
        const DEFAULT_FUND_TYPES = [
            { id: 'scbs_p500e', name: 'SCBS&P500E', color: '#4F46E5', currentNAV: 28.00 }
        ];
        
        // Load or initialize fund types
        window.fundTypes = JSON.parse(localStorage.getItem('fundTypes')) || [...DEFAULT_FUND_TYPES];
        
        function saveFundTypes() {
            localStorage.setItem('fundTypes', JSON.stringify(window.fundTypes));
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderDashboard();
            addExpenseRow();
            addInvestmentRow('scbs_p500e'); // Add default investment
            calculateRemaining();
        });

        // --- CORE FUNCTIONS ---

        window.saveData = function() {
            records.sort((a, b) => new Date(a.month) - new Date(b.month));
            localStorage.setItem('wealthData', JSON.stringify(records));
            renderDashboard();
            resetForm();
        }

        function loadData() {
            const stored = localStorage.getItem('wealthData');
            if (stored) {
                window.records = JSON.parse(stored);
            } else {
                window.records = [];
            }
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(records));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "wealth_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    window.records = JSON.parse(e.target.result);
                    saveData();
                    showNotification("‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                } catch (err) {
                    showNotification("‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }
            };
            reader.readAsText(file);
        }

        // --- EXPENSE MANAGEMENT ---

        function addExpenseRow(name = '', amount = '') {
            const container = document.getElementById('expenseContainer');
            const rowId = `expense_${expenseRowCounter++}`;
            
            const row = document.createElement('div');
            row.className = 'flex gap-1 sm:gap-2 items-center';
            row.id = rowId;
            row.innerHTML = `
                <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" value="${name}" 
                    class="flex-1 min-w-0 rounded-md border-gray-300 border p-1.5 sm:p-2 text-xs sm:text-sm focus:border-orange-500" 
                    oninput="calculateRemaining()">
                <input type="number" placeholder="0" value="${amount}" step="0.01"
                    class="w-20 sm:w-28 rounded-md border-gray-300 border p-1.5 sm:p-2 text-xs sm:text-sm text-right focus:border-orange-500" 
                    oninput="calculateRemaining()">
                <button type="button" onclick="removeExpenseRow('${rowId}')" 
                    class="w-7 h-7 sm:w-8 sm:h-8 flex items-center justify-center bg-red-100 text-red-500 rounded hover:bg-red-500 hover:text-white transition flex-shrink-0">
                    <i class="fas fa-times text-xs"></i>
                </button>
            `;
            container.appendChild(row);
            calculateRemaining();
        }

        function removeExpenseRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                calculateRemaining();
            }
        }

        function getExpenseItems() {
            const items = [];
            document.querySelectorAll('#expenseContainer > div').forEach(row => {
                const inputs = row.querySelectorAll('input');
                const name = inputs[0].value.trim();
                const amount = parseFloat(inputs[1].value) || 0;
                if (name && amount > 0) {
                    items.push({ name, amount });
                }
            });
            return items;
        }

        function getTotalExpenses() {
            let total = 0;
            document.querySelectorAll('#expenseContainer > div').forEach(row => {
                const amountInput = row.querySelectorAll('input')[1];
                total += parseFloat(amountInput.value) || 0;
            });
            return total;
        }

        // --- INVESTMENT MANAGEMENT FUNCTIONS ---
        
        function getFundById(id) {
            return window.fundTypes.find(f => f.id === id);
        }
        
        function addInvestmentRow(fundId = null, amount = '', nav = '') {
            const container = document.getElementById('investmentContainer');
            const rowId = `investment_${investmentRowCounter++}`;
            const fund = fundId ? getFundById(fundId) : null;
            
            const row = document.createElement('div');
            row.className = 'flex gap-1 sm:gap-2 items-center bg-white p-2 rounded-lg border border-indigo-100';
            row.id = rowId;
            row.dataset.fundId = fundId || '';
            
            const fundName = fund ? fund.name : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô';
            const fundColor = fund ? fund.color : '#9CA3AF';
            
            row.innerHTML = `
                <button type="button" onclick="openFundSelect('${rowId}')" 
                    class="flex-1 min-w-0 text-left rounded-md border-gray-300 border p-1.5 sm:p-2 text-xs sm:text-sm bg-gray-50 hover:bg-gray-100 transition truncate"
                    style="border-left: 3px solid ${fundColor}">
                    ${fundName}
                </button>
                <input type="number" placeholder="‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô" value="${amount}" step="0.01"
                    class="w-16 sm:w-24 rounded-md border-gray-300 border p-1.5 sm:p-2 text-xs sm:text-sm text-right focus:border-indigo-500 investment-amount" 
                    oninput="calculateRemaining()">
                <input type="number" placeholder="NAV" value="${nav}" step="0.0001"
                    class="w-14 sm:w-20 rounded-md border-gray-300 border p-1.5 sm:p-2 text-xs sm:text-sm text-right focus:border-indigo-500 investment-nav">
                <button type="button" onclick="removeInvestmentRow('${rowId}')" 
                    class="w-7 h-7 sm:w-8 sm:h-8 flex items-center justify-center bg-red-100 text-red-500 rounded hover:bg-red-500 hover:text-white transition flex-shrink-0">
                    <i class="fas fa-times text-xs"></i>
                </button>
            `;
            container.appendChild(row);
            calculateRemaining();
        }
        
        function removeInvestmentRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                calculateRemaining();
            }
        }
        
        function getInvestmentItems() {
            const items = [];
            document.querySelectorAll('#investmentContainer > div').forEach(row => {
                const fundId = row.dataset.fundId;
                const amount = parseFloat(row.querySelector('.investment-amount').value) || 0;
                const nav = parseFloat(row.querySelector('.investment-nav').value) || 0;
                if (fundId && amount > 0) {
                    const units = nav > 0 ? amount / nav : 0;
                    items.push({ fundId, amount, nav, units });
                }
            });
            return items;
        }
        
        function getTotalInvestments() {
            let total = 0;
            document.querySelectorAll('.investment-amount').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            return total;
        }
        
        // --- FUND SELECT MODAL ---
        
        function openFundSelect(rowId) {
            currentSelectingRowId = rowId;
            const modal = document.getElementById('fundSelectModal');
            const list = document.getElementById('fundSelectList');
            
            list.innerHTML = window.fundTypes.map(fund => `
                <button onclick="selectFund('${fund.id}')" 
                    class="w-full text-left p-3 rounded-lg border hover:bg-indigo-50 transition flex items-center gap-3"
                    style="border-left: 4px solid ${fund.color}">
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">${fund.name}</div>
                        <div class="text-xs text-gray-500">NAV: ‡∏ø${fund.currentNAV.toFixed(2)}</div>
                    </div>
                    <button onclick="event.stopPropagation(); deleteFund('${fund.id}')" 
                        class="text-red-400 hover:text-red-600 p-1" title="‡∏•‡∏ö‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </button>
            `).join('') || '<p class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏´‡∏°‡πà</p>';
            
            modal.classList.remove('hidden');
        }
        
        function closeFundSelectModal() {
            document.getElementById('fundSelectModal').classList.add('hidden');
            currentSelectingRowId = null;
        }
        
        function selectFund(fundId) {
            if (!currentSelectingRowId) return;
            
            const row = document.getElementById(currentSelectingRowId);
            const fund = getFundById(fundId);
            
            if (row && fund) {
                row.dataset.fundId = fundId;
                const btn = row.querySelector('button');
                btn.innerHTML = fund.name;
                btn.style.borderLeftColor = fund.color;
            }
            
            closeFundSelectModal();
            calculateRemaining();
        }
        
        function deleteFund(fundId) {
            if (!confirm('‡∏•‡∏ö‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            
            window.fundTypes = window.fundTypes.filter(f => f.id !== fundId);
            saveFundTypes();
            
            // Re-open the modal to refresh
            if (currentSelectingRowId) {
                openFundSelect(currentSelectingRowId);
            }
        }
        
        // --- ADD NEW FUND MODAL ---
        
        function showAddNewFundForm() {
            closeFundSelectModal();
            document.getElementById('addFundModal').classList.remove('hidden');
            document.getElementById('newFundName').value = '';
            document.getElementById('newFundNAV').value = '';
            document.getElementById('newFundColor').value = '#4F46E5';
            document.getElementById('newFundColorText').value = '#4F46E5';
        }
        
        function closeAddFundModal() {
            document.getElementById('addFundModal').classList.add('hidden');
        }
        
        function saveNewFund() {
            const name = document.getElementById('newFundName').value.trim();
            const nav = parseFloat(document.getElementById('newFundNAV').value) || 0;
            const color = document.getElementById('newFundColor').value;
            
            if (!name) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô');
                return;
            }
            
            const id = name.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + Date.now();
            
            window.fundTypes.push({ id, name, color, currentNAV: nav });
            saveFundTypes();
            
            closeAddFundModal();
            
            // If we were selecting for a row, open the modal again
            if (currentSelectingRowId) {
                openFundSelect(currentSelectingRowId);
            }
            
            showNotification('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        }
        
        // --- NAV UPDATE MODAL ---
        
        function openNAVModal() {
            const modal = document.getElementById('navModal');
            const content = document.getElementById('navModalContent');
            
            content.innerHTML = window.fundTypes.map(fund => `
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg" style="border-left: 4px solid ${fund.color}">
                    <div class="flex-1">
                        <div class="font-medium text-gray-800 text-sm">${fund.name}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500">NAV:</span>
                        <input type="number" value="${fund.currentNAV}" step="0.0001" 
                            class="w-24 border rounded p-1.5 text-sm text-right nav-update-input"
                            data-fund-id="${fund.id}">
                        <span class="text-xs text-gray-500">‡∏ö‡∏≤‡∏ó</span>
                    </div>
                </div>
            `).join('') || '<p class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô</p>';
            
            modal.classList.remove('hidden');
        }
        
        function closeNAVModal() {
            document.getElementById('navModal').classList.add('hidden');
        }
        
        function saveNAVUpdates() {
            document.querySelectorAll('.nav-update-input').forEach(input => {
                const fundId = input.dataset.fundId;
                const newNAV = parseFloat(input.value) || 0;
                
                const fund = getFundById(fundId);
                if (fund) {
                    fund.currentNAV = newNAV;
                }
            });
            
            saveFundTypes();
            closeNAVModal();
            renderDashboard();
            showNotification('‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó NAV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        }
        
        // Sync color input
        document.getElementById('newFundColor')?.addEventListener('input', function() {
            document.getElementById('newFundColorText').value = this.value;
        });

        // --- CALCULATION ---

        function calculateRemaining() {
            const salary = parseFloat(document.getElementById('inputSalary').value) || 0;
            const totalExpenses = getTotalExpenses();
            const totalInvestments = getTotalInvestments();
            
            const remaining = salary - totalExpenses - totalInvestments;
            
            document.getElementById('totalExpenseDisplay').textContent = `‡∏ø${totalExpenses.toLocaleString()}`;
            document.getElementById('totalInvestmentDisplay').textContent = `‡∏ø${totalInvestments.toLocaleString()}`;
            document.getElementById('remainingDisplay').textContent = `‡∏ø${remaining.toLocaleString()}`;
            document.getElementById('autoEmergencyValue').textContent = `‡∏ø${Math.max(0, remaining).toLocaleString()}`;
            
            const remainingEl = document.getElementById('remainingDisplay');
            if (remaining < 0) {
                remainingEl.classList.remove('text-gray-800', 'text-green-600');
                remainingEl.classList.add('text-red-500');
            } else {
                remainingEl.classList.remove('text-red-500');
                remainingEl.classList.add('text-green-600');
            }
            
            const emergencyType = document.querySelector('input[name="emergencyType"]:checked')?.value || 'auto';
            if (emergencyType === 'custom') {
                const customAmount = parseFloat(document.getElementById('inputEmergency').value) || 0;
                const warningEl = document.getElementById('emergencyWarning');
                if (customAmount > remaining) {
                    warningEl.textContent = `‚ö†Ô∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (${remaining.toLocaleString()} ‡∏ö‡∏≤‡∏ó)`;
                    warningEl.classList.remove('hidden');
                } else {
                    warningEl.classList.add('hidden');
                }
            }
        }

        function toggleEmergencyMode() {
            const emergencyType = document.querySelector('input[name="emergencyType"]:checked').value;
            const customSection = document.getElementById('customEmergencySection');
            const autoLabel = document.getElementById('radioAutoLabel');
            const customLabel = document.getElementById('radioCustomLabel');
            
            if (emergencyType === 'custom') {
                customSection.classList.remove('hidden');
                autoLabel.classList.remove('border-green-500');
                autoLabel.classList.add('border-gray-200');
                customLabel.classList.remove('border-gray-200');
                customLabel.classList.add('border-green-500');
            } else {
                customSection.classList.add('hidden');
                autoLabel.classList.remove('border-gray-200');
                autoLabel.classList.add('border-green-500');
                customLabel.classList.remove('border-green-500');
                customLabel.classList.add('border-gray-200');
            }
            calculateRemaining();
        }

        // --- FORM HANDLING ---

        const form = document.getElementById('dataForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const editIndex = document.getElementById('editIndex').value;
            
            const salary = parseFloat(document.getElementById('inputSalary').value) || 0;
            const expenses = getExpenseItems();
            const investments = getInvestmentItems();
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
            const totalInvestments = investments.reduce((sum, i) => sum + i.amount, 0);
            const remaining = salary - totalExpenses - totalInvestments;
            
            const emergencyType = document.querySelector('input[name="emergencyType"]:checked')?.value || 'auto';
            let emergency;
            if (emergencyType === 'auto') {
                emergency = Math.max(0, remaining);
            } else {
                emergency = parseFloat(document.getElementById('inputEmergency').value) || 0;
            }
            
            const newRecord = {
                month: document.getElementById('inputMonth').value,
                salary: salary,
                emergency: emergency,
                expenses: expenses,
                investments: investments,
                // Keep legacy fields for backward compatibility
                dca: totalInvestments,
                indexPrice: investments.length > 0 && investments[0].nav > 0 ? investments[0].nav : 0
            };

            if (editIndex !== "") {
                window.records[editIndex] = newRecord;
            } else {
                const existing = window.records.findIndex(r => r.month === newRecord.month);
                if (existing >= 0) {
                    if(!confirm("‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
                    window.records[existing] = newRecord;
                } else {
                    window.records.push(newRecord);
                }
            }
            saveData();
        });

        function editRecord(index) {
            const r = window.records[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('inputMonth').value = r.month;
            document.getElementById('inputSalary').value = r.salary || 0;
            
            // Clear and populate expenses
            document.getElementById('expenseContainer').innerHTML = '';
            expenseRowCounter = 0;
            
            if (r.expenses && Array.isArray(r.expenses)) {
                r.expenses.forEach(exp => addExpenseRow(exp.name, exp.amount));
            } else if (r.expense) {
                addExpenseRow('‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', r.expense);
            }
            
            if (document.querySelectorAll('#expenseContainer > div').length === 0) {
                addExpenseRow();
            }
            
            // Clear and populate investments
            document.getElementById('investmentContainer').innerHTML = '';
            investmentRowCounter = 0;
            
            if (r.investments && Array.isArray(r.investments)) {
                r.investments.forEach(inv => addInvestmentRow(inv.fundId, inv.amount, inv.nav));
            } else if (r.dca > 0) {
                // Legacy support: convert old dca/indexPrice to new format
                addInvestmentRow('scbs_p500e', r.dca, r.indexPrice);
            }
            
            if (document.querySelectorAll('#investmentContainer > div').length === 0) {
                addInvestmentRow('scbs_p500e');
            }
            
            const salary = r.salary || 0;
            const totalExpenses = r.expenses ? r.expenses.reduce((sum, e) => sum + e.amount, 0) : (r.expense || 0);
            const totalInvestments = r.investments ? r.investments.reduce((sum, i) => sum + i.amount, 0) : (r.dca || 0);
            const remaining = salary - totalExpenses - totalInvestments;
            
            if (Math.abs(r.emergency - Math.max(0, remaining)) < 1) {
                document.querySelector('input[name="emergencyType"][value="auto"]').checked = true;
            } else {
                document.querySelector('input[name="emergencyType"][value="custom"]').checked = true;
                document.getElementById('inputEmergency').value = r.emergency;
            }
            toggleEmergencyMode();
            calculateRemaining();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteRecord(index) {
            if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ?')) {
                window.records.splice(index, 1);
                saveData();
            }
        }

        function duplicateRecord(index) {
            const r = window.records[index];
            
            document.getElementById('editIndex').value = "";
            
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('inputMonth').value = currentMonth;
            
            document.getElementById('inputSalary').value = r.salary || 0;
            
            // Clear and populate expenses
            document.getElementById('expenseContainer').innerHTML = '';
            expenseRowCounter = 0;
            
            if (r.expenses && Array.isArray(r.expenses)) {
                r.expenses.forEach(exp => addExpenseRow(exp.name, exp.amount));
            } else if (r.expense) {
                addExpenseRow('‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', r.expense);
            }
            
            if (document.querySelectorAll('#expenseContainer > div').length === 0) {
                addExpenseRow();
            }
            
            // Clear and populate investments (without NAV - user needs to update)
            document.getElementById('investmentContainer').innerHTML = '';
            investmentRowCounter = 0;
            
            if (r.investments && Array.isArray(r.investments)) {
                r.investments.forEach(inv => addInvestmentRow(inv.fundId, inv.amount, '')); // No NAV for new month
            } else if (r.dca > 0) {
                addInvestmentRow('scbs_p500e', r.dca, '');
            }
            
            if (document.querySelectorAll('#investmentContainer > div').length === 0) {
                addInvestmentRow('scbs_p500e');
            }
            
            const salary = r.salary || 0;
            const totalExpenses = r.expenses ? r.expenses.reduce((sum, e) => sum + e.amount, 0) : (r.expense || 0);
            const totalInvestments = r.investments ? r.investments.reduce((sum, i) => sum + i.amount, 0) : (r.dca || 0);
            const remaining = salary - totalExpenses - totalInvestments;
            
            if (Math.abs(r.emergency - Math.max(0, remaining)) < 1) {
                document.querySelector('input[name="emergencyType"][value="auto"]').checked = true;
            } else {
                document.querySelector('input[name="emergencyType"][value="custom"]').checked = true;
                document.getElementById('inputEmergency').value = r.emergency;
            }
            toggleEmergencyMode();
            calculateRemaining();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showNotification('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å NAV ‡πÉ‡∏´‡∏°‡πà');
        }

        window.showNotification = function(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-indigo-600 text-white px-4 py-3 rounded-lg shadow-lg z-50 animate-pulse';
            notification.innerHTML = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transition = 'opacity 0.3s';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        window.resetForm = function() {
            form.reset();
            document.getElementById('editIndex').value = "";
            
            // Reset expenses
            document.getElementById('expenseContainer').innerHTML = '';
            expenseRowCounter = 0;
            addExpenseRow();
            
            // Reset investments
            document.getElementById('investmentContainer').innerHTML = '';
            investmentRowCounter = 0;
            addInvestmentRow('scbs_p500e');
            
            document.querySelector('input[name="emergencyType"][value="auto"]').checked = true;
            toggleEmergencyMode();
            
            calculateRemaining();
        }

        // --- RENDERING & CHARTS ---

        let myChart = null;

        function getRecordTotalExpenses(r) {
            if (r.expenses && Array.isArray(r.expenses)) {
                return r.expenses.reduce((sum, e) => sum + e.amount, 0);
            }
            return r.expense || 0;
        }

        function isFutureMonth(monthStr) {
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            return monthStr > currentMonth;
        }

        function getCurrentMonth() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }

        // Helper to get investments from a record (with legacy support)
        function getRecordInvestments(r) {
            if (r.investments && Array.isArray(r.investments)) {
                return r.investments;
            }
            // Legacy support
            if (r.dca > 0) {
                return [{ fundId: 'scbs_p500e', amount: r.dca, nav: r.indexPrice || 0, units: r.indexPrice > 0 ? r.dca / r.indexPrice : 0 }];
            }
            return [];
        }
        
        window.renderDashboard = function() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            // Aggregate data by fund
            const fundAggregates = {};
            let totalInvestedAll = 0;
            let totalCurrentValueAll = 0;

            window.records.forEach((r, index) => {
                const totalExpense = getRecordTotalExpenses(r);
                const isFuture = isFutureMonth(r.month);
                const investments = getRecordInvestments(r);
                const totalInvestment = investments.reduce((sum, i) => sum + i.amount, 0);
                
                // Aggregate for portfolio (only non-future)
                if (!isFuture) {
                    investments.forEach(inv => {
                        if (inv.amount > 0 && inv.nav > 0) {
                            const units = inv.amount / inv.nav;
                            if (!fundAggregates[inv.fundId]) {
                                fundAggregates[inv.fundId] = { totalInvested: 0, totalUnits: 0 };
                            }
                            fundAggregates[inv.fundId].totalInvested += inv.amount;
                            fundAggregates[inv.fundId].totalUnits += units;
                        }
                    });
                }
                
                const tr = document.createElement('tr');
                
                if (isFuture) {
                    tr.className = "bg-gray-100 opacity-60 cursor-pointer transition hover:opacity-80";
                } else {
                    tr.className = "hover:bg-gray-50 cursor-pointer transition";
                }
                
                tr.onclick = (e) => { if(e.target.tagName !== 'BUTTON' && e.target.tagName !== 'I') editRecord(index); };
                
                let expenseDisplay = totalExpense.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
                if (r.expenses && r.expenses.length > 1) {
                    const expenseList = r.expenses.map(e => `${e.name}: ‡∏ø${e.amount.toLocaleString()}`).join('\n');
                    expenseDisplay = `<span title="${expenseList}" class="cursor-help border-b border-dashed border-gray-400">${totalExpense.toLocaleString()}</span>`;
                }
                
                let monthDisplay = r.month;
                if (isFuture) {
                    monthDisplay = `${r.month} <span class="ml-1 px-1 py-0.5 bg-yellow-100 text-yellow-700 text-[8px] sm:text-xs rounded font-medium hidden sm:inline">üìÖ</span>`;
                }
                
                // Investment display
                const investmentNames = investments.map(inv => {
                    const fund = getFundById(inv.fundId);
                    return fund ? fund.name : inv.fundId;
                }).filter((v, i, a) => a.indexOf(v) === i).join(', ');
                
                tr.innerHTML = `
                    <td class="px-1.5 sm:px-4 py-2 sm:py-4 whitespace-nowrap font-medium text-[10px] sm:text-sm ${isFuture ? 'text-gray-500' : 'text-gray-900'}">${monthDisplay}</td>
                    <td class="px-1.5 sm:px-4 py-2 sm:py-4 whitespace-nowrap text-right text-[10px] sm:text-sm ${isFuture ? 'text-gray-400' : 'text-purple-600'} hidden sm:table-cell">${(r.salary || 0).toLocaleString()}</td>
                    <td class="px-1.5 sm:px-4 py-2 sm:py-4 whitespace-nowrap text-right text-[10px] sm:text-sm ${isFuture ? 'text-gray-400' : 'text-green-600'}">${(r.emergency || 0).toLocaleString()}</td>
                    <td class="px-1.5 sm:px-4 py-2 sm:py-4 whitespace-nowrap text-right text-[10px] sm:text-sm ${isFuture ? 'text-gray-400' : 'text-red-500'} hidden sm:table-cell">${expenseDisplay}</td>
                    <td class="px-1.5 sm:px-4 py-2 sm:py-4 whitespace-nowrap text-right text-[10px] sm:text-sm ${isFuture ? 'text-gray-400' : 'text-indigo-600'} font-medium">${totalInvestment.toLocaleString()}</td>
                    <td class="px-1.5 sm:px-4 py-2 sm:py-4 whitespace-nowrap text-left text-[10px] sm:text-sm text-gray-500 hidden sm:table-cell truncate max-w-[100px]" title="${investmentNames}">${investmentNames || '-'}</td>
                    <td class="px-1 sm:px-4 py-2 sm:py-4 whitespace-nowrap text-center font-medium">
                        <button onclick="duplicateRecord(${index})" class="text-indigo-600 hover:text-indigo-900 p-1" title="Duplicate"><i class="fas fa-copy text-[10px] sm:text-sm"></i></button>
                        <button onclick="deleteRecord(${index})" class="text-red-600 hover:text-red-900 p-1" title="Delete"><i class="fas fa-trash text-[10px] sm:text-sm"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Calculate portfolio values for each fund
            const breakdownContainer = document.getElementById('investmentBreakdown');
            breakdownContainer.innerHTML = '';
            
            let activeFundCount = 0;
            
            Object.keys(fundAggregates).forEach(fundId => {
                const agg = fundAggregates[fundId];
                const fund = getFundById(fundId);
                if (!fund) return;
                
                const currentValue = agg.totalUnits * fund.currentNAV;
                const profit = currentValue - agg.totalInvested;
                const profitPercent = agg.totalInvested > 0 ? (profit / agg.totalInvested) * 100 : 0;
                
                totalInvestedAll += agg.totalInvested;
                totalCurrentValueAll += currentValue;
                activeFundCount++;
                
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center text-[10px] sm:text-xs';
                item.innerHTML = `
                    <div class="flex items-center gap-1.5 min-w-0">
                        <span class="w-2 h-2 rounded-full flex-shrink-0" style="background: ${fund.color}"></span>
                        <span class="truncate">${fund.name}</span>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <span class="text-indigo-200">‡∏ø${currentValue.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                        <span class="${profit >= 0 ? 'text-green-300' : 'text-red-300'}">${profit >= 0 ? '+' : ''}${profitPercent.toFixed(1)}%</span>
                    </div>
                `;
                breakdownContainer.appendChild(item);
            });
            
            if (activeFundCount === 0) {
                breakdownContainer.innerHTML = '<p class="text-indigo-200 text-[10px] sm:text-xs text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô</p>';
            }

            // Total portfolio
            const totalProfit = totalCurrentValueAll - totalInvestedAll;
            const totalProfitPercent = totalInvestedAll > 0 ? (totalProfit / totalInvestedAll) * 100 : 0;

            document.getElementById('portValue').innerText = `‡∏ø${totalCurrentValueAll.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            
            const returnEl = document.getElementById('portReturn');
            returnEl.innerHTML = `${totalProfit >= 0 ? '+' : ''}‡∏ø${totalProfit.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            returnEl.className = `text-base sm:text-xl font-bold mt-1 truncate ${totalProfit >= 0 ? 'text-green-300' : 'text-red-300'}`;
            
            document.getElementById('portReturnPercent').innerText = `${totalProfit >= 0 ? '+' : ''}${totalProfitPercent.toFixed(1)}%`;
            document.getElementById('portReturnPercent').className = `text-[10px] sm:text-xs ${totalProfit >= 0 ? 'text-green-300' : 'text-red-300'}`;
            
            document.getElementById('totalCost').innerText = `‡∏ø${totalInvestedAll.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            document.getElementById('fundCount').innerText = activeFundCount;

            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            const validRecords = window.records.filter(r => !isFutureMonth(r.month));
            
            const labels = validRecords.map(r => r.month);
            const dataEmergency = validRecords.map(r => r.emergency || 0);
            const dataExpense = validRecords.map(r => getRecordTotalExpenses(r));
            
            // Build datasets for each fund
            const fundDatasets = [];
            const fundColors = {};
            
            // Collect all unique fund IDs from records
            const allFundIds = new Set();
            validRecords.forEach(r => {
                getRecordInvestments(r).forEach(inv => allFundIds.add(inv.fundId));
            });
            
            allFundIds.forEach(fundId => {
                const fund = getFundById(fundId);
                const color = fund ? fund.color : '#9CA3AF';
                const name = fund ? fund.name : fundId;
                
                fundDatasets.push({
                    label: name,
                    data: validRecords.map(r => {
                        const investments = getRecordInvestments(r);
                        const fundInv = investments.filter(i => i.fundId === fundId);
                        return fundInv.reduce((sum, i) => sum + i.amount, 0);
                    }),
                    backgroundColor: color,
                    stack: 'Stack 0',
                });
            });
            
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô',
                            data: dataEmergency,
                            backgroundColor: '#fbbf24',
                            stack: 'Stack 1',
                        },
                        ...fundDatasets,
                        {
                            label: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢',
                            data: dataExpense,
                            type: 'line',
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 3,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false } },
                        y: { stacked: true, beginAtZero: true }
                    },
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: { 
                                boxWidth: 12, 
                                font: { size: 10 } 
                            }
                        },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        }
    </script>
</body>
</html>
